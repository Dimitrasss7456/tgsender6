
{% extends "base.html" %}

{% block title %}Статистика кампаний - Telegram Mass Sender{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-chart-bar me-2"></i>Статистика кампаний
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button class="btn btn-outline-secondary" onclick="refreshStats()">
            <i class="fas fa-sync-alt"></i> Обновить
        </button>
    </div>
</div>

<!-- Общая статистика -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Всего кампаний</h6>
                        <h4 id="total-campaigns">0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-bullhorn fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Отправлено сообщений</h6>
                        <h4 id="total-sent">0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Ошибки</h6>
                        <h4 id="total-failed">0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-times-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Успешность</h6>
                        <h4 id="success-rate">0%</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-percentage fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Детальная статистика по кампаниям -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>Детальная статистика по кампаниям
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="campaigns-table">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Название кампании</th>
                        <th>Статус</th>
                        <th>Создана</th>
                        <th>Отправлено</th>
                        <th>Ошибки</th>
                        <th>Всего целей</th>
                        <th>Успешность</th>
                        <th>Использованные аккаунты</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="campaigns-tbody">
                    <!-- Данные будут загружены через JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Модальное окно для детальной информации о кампании -->
<div class="modal fade" id="campaignDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детали кампании</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="campaign-detail-content">
                <!-- Содержимое загружается динамически -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let campaignsData = [];

// Загрузка статистики при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadCampaignStats();
});

async function loadCampaignStats() {
    try {
        showLoading();
        const response = await fetch('/api/campaign-stats');
        const data = await response.json();
        
        if (data.status === 'success') {
            campaignsData = data.campaigns;
            updateOverallStats(data.overall);
            renderCampaignsTable(data.campaigns);
        } else {
            showError('Ошибка загрузки статистики: ' + data.message);
        }
    } catch (error) {
        showError('Ошибка загрузки статистики: ' + error.message);
    } finally {
        hideLoading();
    }
}

function updateOverallStats(stats) {
    document.getElementById('total-campaigns').textContent = stats.total_campaigns;
    document.getElementById('total-sent').textContent = stats.total_sent;
    document.getElementById('total-failed').textContent = stats.total_failed;
    document.getElementById('success-rate').textContent = stats.success_rate + '%';
}

function renderCampaignsTable(campaigns) {
    const tbody = document.getElementById('campaigns-tbody');
    tbody.innerHTML = '';

    campaigns.forEach(campaign => {
        const row = document.createElement('tr');
        
        const statusBadge = getStatusBadge(campaign.status);
        const successRate = campaign.total_targets > 0 ? 
            Math.round((campaign.sent_count / campaign.total_targets) * 100) : 0;
        
        row.innerHTML = `
            <td>${campaign.id}</td>
            <td>
                <div class="fw-bold">${campaign.name}</div>
                <small class="text-muted">ID: ${campaign.id}</small>
            </td>
            <td>${statusBadge}</td>
            <td>
                <div>${new Date(campaign.created_at).toLocaleDateString('ru-RU')}</div>
                <small class="text-muted">${new Date(campaign.created_at).toLocaleTimeString('ru-RU')}</small>
            </td>
            <td>
                <span class="badge bg-success">${campaign.sent_count}</span>
            </td>
            <td>
                <span class="badge bg-danger">${campaign.failed_count}</span>
            </td>
            <td>
                <span class="badge bg-info">${campaign.total_targets}</span>
            </td>
            <td>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar ${getProgressBarClass(successRate)}" 
                         role="progressbar" 
                         style="width: ${successRate}%"
                         aria-valuenow="${successRate}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        ${successRate}%
                    </div>
                </div>
            </td>
            <td>
                <span class="badge bg-secondary">${campaign.accounts_used}</span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="showCampaignDetails(${campaign.id})">
                    <i class="fas fa-eye"></i> Детали
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function getStatusBadge(status) {
    const statusMap = {
        'created': '<span class="badge bg-secondary">Создана</span>',
        'running': '<span class="badge bg-primary">Выполняется</span>',
        'completed': '<span class="badge bg-success">Завершена</span>',
        'paused': '<span class="badge bg-warning">Приостановлена</span>',
        'error': '<span class="badge bg-danger">Ошибка</span>',
        'cancelled': '<span class="badge bg-dark">Отменена</span>'
    };
    return statusMap[status] || '<span class="badge bg-secondary">Неизвестно</span>';
}

function getProgressBarClass(rate) {
    if (rate >= 80) return 'bg-success';
    if (rate >= 60) return 'bg-info';
    if (rate >= 40) return 'bg-warning';
    return 'bg-danger';
}

async function showCampaignDetails(campaignId) {
    try {
        const response = await fetch(`/api/campaign-details/${campaignId}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            const campaign = data.campaign;
            const logs = data.logs;
            
            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Основная информация</h6>
                        <table class="table table-sm">
                            <tr><td><strong>ID:</strong></td><td>${campaign.id}</td></tr>
                            <tr><td><strong>Название:</strong></td><td>${campaign.name}</td></tr>
                            <tr><td><strong>Статус:</strong></td><td>${getStatusBadge(campaign.status)}</td></tr>
                            <tr><td><strong>Создана:</strong></td><td>${new Date(campaign.created_at).toLocaleString('ru-RU')}</td></tr>
                            <tr><td><strong>Задержка:</strong></td><td>${campaign.delay_seconds} сек</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Статистика отправки</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Отправлено:</strong></td><td><span class="badge bg-success">${campaign.sent_count}</span></td></tr>
                            <tr><td><strong>Ошибки:</strong></td><td><span class="badge bg-danger">${campaign.failed_count}</span></td></tr>
                            <tr><td><strong>Всего целей:</strong></td><td><span class="badge bg-info">${campaign.total_targets}</span></td></tr>
                            <tr><td><strong>Успешность:</strong></td><td>${Math.round((campaign.sent_count / campaign.total_targets) * 100)}%</td></tr>
                        </table>
                    </div>
                </div>
                
                ${campaign.private_message ? `
                <div class="mt-3">
                    <h6>Сообщение</h6>
                    <div class="alert alert-light">
                        ${campaign.private_message.replace(/\n/g, '<br>')}
                    </div>
                </div>
                ` : ''}
                
                <div class="mt-3">
                    <h6>Последние попытки отправки</h6>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Получатель</th>
                                    <th>Статус</th>
                                    <th>Время</th>
                                    <th>Ошибка</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${logs.map(log => `
                                    <tr>
                                        <td>${log.recipient}</td>
                                        <td>
                                            ${log.status === 'sent' ? 
                                                '<span class="badge bg-success">Отправлено</span>' : 
                                                '<span class="badge bg-danger">Ошибка</span>'
                                            }
                                        </td>
                                        <td>${new Date(log.sent_at).toLocaleString('ru-RU')}</td>
                                        <td>${log.error_message || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('campaign-detail-content').innerHTML = content;
            new bootstrap.Modal(document.getElementById('campaignDetailModal')).show();
        } else {
            showError('Ошибка загрузки деталей кампании: ' + data.message);
        }
    } catch (error) {
        showError('Ошибка загрузки деталей кампании: ' + error.message);
    }
}

function refreshStats() {
    loadCampaignStats();
}

function showLoading() {
    const tbody = document.getElementById('campaigns-tbody');
    tbody.innerHTML = '<tr><td colspan="10" class="text-center"><i class="fas fa-spinner fa-spin"></i> Загрузка...</td></tr>';
}

function hideLoading() {
    // Функция будет вызвана после загрузки данных
}

function showError(message) {
    const tbody = document.getElementById('campaigns-tbody');
    tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">${message}</td></tr>`;
}

// Автообновление каждые 30 секунд
setInterval(loadCampaignStats, 30000);
</script>
{% endblock %}
