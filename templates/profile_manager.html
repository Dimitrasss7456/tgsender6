
{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è–º–∏ - Telegram Mass Sender{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-user-cog me-2"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è–º–∏</h4>
                </div>
                <div class="card-body">
                    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º -->
                    <ul class="nav nav-tabs mb-4" id="profileTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="profiles-tab" data-bs-toggle="tab" data-bs-target="#profiles-pane" type="button" role="tab">
                                <i class="fas fa-users me-2"></i>
                                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="reactions-tab" data-bs-toggle="tab" data-bs-target="#reactions-pane" type="button" role="tab">
                                <i class="fas fa-thumbs-up me-2"></i>
                                –†–µ–∞–∫—Ü–∏–∏
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="views-tab" data-bs-toggle="tab" data-bs-target="#views-pane" type="button" role="tab">
                                <i class="fas fa-eye me-2"></i>
                                –ü—Ä–æ—Å–º–æ—Ç—Ä—ã
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments-pane" type="button" role="tab">
                                <i class="fas fa-comments me-2"></i>
                                –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                            </button>
                        </li>
                    </ul>

                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
                    <div class="tab-content" id="profileTabContent">
                        <!-- –í–∫–ª–∞–¥–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π -->
                        <div class="tab-pane fade show active" id="profiles-pane" role="tabpanel">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="fas fa-magic me-2"></i>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ</h5>
                                        </div>
                                        <div class="card-body">
                                            <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∏–º–µ–Ω–∞, —Ñ–∞–º–∏–ª–∏–∏ –∏ –≥–µ–Ω–¥–µ—Ä—ã –≤—Å–µ–º –∞–∫–∫–∞—É–Ω—Ç–∞–º</p>
                                            <button type="button" class="btn btn-primary" onclick="autoAssignGenders()">
                                                <i class="fas fa-robot me-2"></i>–ê–≤—Ç–æ-–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="fas fa-upload me-2"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–∫–∏ –∏–º–µ–Ω</h5>
                                        </div>
                                        <div class="card-body">
                                            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã —Å –∏–º–µ–Ω–∞–º–∏ –∏ —Ñ–∞–º–∏–ª–∏—è–º–∏ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</p>
                                            <form id="uploadNamesForm" enctype="multipart/form-data">
                                                <div class="mb-3">
                                                    <label class="form-label">–§–∞–π–ª —Å –∏–º–µ–Ω–∞–º–∏ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
                                                    <input type="file" class="form-control" id="firstNamesFile" accept=".txt">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">–§–∞–π–ª —Å —Ñ–∞–º–∏–ª–∏—è–º–∏ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
                                                    <input type="file" class="form-control" id="lastNamesFile" accept=".txt">
                                                </div>
                                                <button type="submit" class="btn btn-secondary">
                                                    <i class="fas fa-upload me-2"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- –°–ø–∏—Å–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ -->
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                            <th>–¢–µ–∫—É—â–µ–µ –∏–º—è</th>
                                            <th>–ò–º—è</th>
                                            <th>–§–∞–º–∏–ª–∏—è</th>
                                            <th>–ë–∏–æ</th>
                                            <th>–ì–µ–Ω–¥–µ—Ä</th>
                                            <th>–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è</th>
                                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for account in accounts %}
                                        <tr id="account-{{ account.id }}">
                                            <td>{{ account.phone }}</td>
                                            <td>{{ account.name or '-' }}</td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm" 
                                                       value="{{ account.first_name or '' }}" 
                                                       onchange="updateAccountField({{ account.id }}, 'first_name', this.value)">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm" 
                                                       value="{{ account.last_name or '' }}" 
                                                       onchange="updateAccountField({{ account.id }}, 'last_name', this.value)">
                                            </td>
                                            <td>
                                                <textarea class="form-control form-control-sm" rows="2" 
                                                          onchange="updateAccountField({{ account.id }}, 'bio', this.value)">{{ account.bio or '' }}</textarea>
                                            </td>
                                            <td>
                                                <select class="form-select form-select-sm" 
                                                        onchange="updateAccountField({{ account.id }}, 'gender', this.value)">
                                                    <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>
                                                    <option value="male" {% if account.gender == 'male' %}selected{% endif %}>–ú—É–∂—Å–∫–æ–π</option>
                                                    <option value="female" {% if account.gender == 'female' %}selected{% endif %}>–ñ–µ–Ω—Å–∫–∏–π</option>
                                                </select>
                                            </td>
                                            <td>
                                                <input type="file" class="form-control form-control-sm" 
                                                       accept="image/*" 
                                                       onchange="uploadProfilePhoto({{ account.id }}, this)">
                                                {% if account.profile_photo_path %}
                                                    <small class="text-success">–ó–∞–≥—Ä—É–∂–µ–Ω–æ</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button class="btn btn-success btn-sm" 
                                                            onclick="updateTelegramProfile({{ account.id }})" 
                                                            title="–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Telegram">
                                                        <i class="fas fa-save"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- –í–∫–ª–∞–¥–∫–∞ —Ä–µ–∞–∫—Ü–∏–π -->
                        <div class="tab-pane fade" id="reactions-pane" role="tabpanel">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-thumbs-up me-2"></i>–ö–∞–º–ø–∞–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–π</h5>
                                </div>
                                <div class="card-body">
                                    <form id="reactionForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="reactionPostUrl" class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç</label>
                                                    <input type="url" class="form-control" id="reactionPostUrl" 
                                                           placeholder="https://t.me/channel/123" required>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="reactionEmoji" class="form-label">–≠–º–æ–¥–∑–∏ —Ä–µ–∞–∫—Ü–∏–∏</label>
                                                    <select class="form-select" id="reactionEmoji" required>
                                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∞–∫—Ü–∏—é</option>
                                                        <option value="üëç">üëç –õ–∞–π–∫</option>
                                                        <option value="‚ù§Ô∏è">‚ù§Ô∏è –°–µ—Ä–¥—Ü–µ</option>
                                                        <option value="üî•">üî• –û–≥–æ–Ω—å</option>
                                                        <option value="üëè">üëè –ê–ø–ª–æ–¥–∏—Å–º–µ–Ω—Ç—ã</option>
                                                        <option value="üòç">üòç –í–ª—é–±–ª–µ–Ω</option>
                                                        <option value="üò±">üò± –®–æ–∫</option>
                                                        <option value="üò¢">üò¢ –ì—Ä—É—Å—Ç—å</option>
                                                        <option value="üò°">üò° –ó–ª–æ—Å—Ç—å</option>
                                                    </select>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="reactionDelay" class="form-label">–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Ä–µ–∞–∫—Ü–∏—è–º–∏ (—Å–µ–∫)</label>
                                                    <input type="number" class="form-control" id="reactionDelay" value="10" min="1">
                                                </div>

                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-play me-2"></i>–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é —Ä–µ–∞–∫—Ü–∏–π
                                                </button>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="alert alert-info">
                                                    <h6><i class="fas fa-info-circle me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                                                    <p>–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–æ—Å—Ç —Å –∑–∞–¥–∞–Ω–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- –í–∫–ª–∞–¥–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ -->
                        <div class="tab-pane fade" id="views-pane" role="tabpanel">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-eye me-2"></i>–ö–∞–º–ø–∞–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</h5>
                                </div>
                                <div class="card-body">
                                    <form id="viewForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="viewPostUrl" class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç</label>
                                                    <input type="url" class="form-control" id="viewPostUrl" 
                                                           placeholder="https://t.me/channel/123" required>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="viewDelay" class="form-label">–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º–∏ (—Å–µ–∫)</label>
                                                    <input type="number" class="form-control" id="viewDelay" value="10" min="1">
                                                </div>

                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-play me-2"></i>–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                                                </button>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="alert alert-info">
                                                    <h6><i class="fas fa-info-circle me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                                                    <p>–ö–∞–º–ø–∞–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –ø–æ–º–æ–∂–µ—Ç —É–≤–µ–ª–∏—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –ø–æ—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É—è –≤–∞—à–∏ –∞–∫–∫–∞—É–Ω—Ç—ã.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- –í–∫–ª–∞–¥–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                        <div class="tab-pane fade" id="comments-pane" role="tabpanel">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-comments me-2"></i>–ö–∞–º–ø–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h5>
                                </div>
                                <div class="card-body">
                                    <form id="commentForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="commentPostUrl" class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç</label>
                                                    <input type="url" class="form-control" id="commentPostUrl" 
                                                           placeholder="https://t.me/channel/123" required>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="maleComments" class="form-label">–ú—É–∂—Å–∫–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
                                                    <textarea class="form-control" id="maleComments" rows="5" 
                                                              placeholder="–û—Ç–ª–∏—á–Ω—ã–π –ø–æ—Å—Ç!&#10;–°–æ–≥–ª–∞—Å–µ–Ω&#10;–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ"></textarea>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="femaleComments" class="form-label">–ñ–µ–Ω—Å–∫–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
                                                    <textarea class="form-control" id="femaleComments" rows="5" 
                                                              placeholder="–û—á–µ–Ω—å –∫—Ä–∞—Å–∏–≤–æ!&#10;–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è&#10;–°—É–ø–µ—Ä!"></textarea>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="commentDelay" class="form-label">–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ (—Å–µ–∫)</label>
                                                    <input type="number" class="form-control" id="commentDelay" value="60" min="1">
                                                </div>

                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-play me-2"></i>–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                                                </button>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="alert alert-info">
                                                    <h6><i class="fas fa-info-circle me-2"></i>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h6>
                                                    <p>1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –º—É–∂—Å–∫–∏–µ –∏ –∂–µ–Ω—Å–∫–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</p>
                                                    <p>2. –°–∏—Å—Ç–µ–º–∞ –≤—ã–±–µ—Ä–µ—Ç –∞–∫–∫–∞—É–Ω—Ç—ã –ø–æ –≥–µ–Ω–¥–µ—Ä–∞–º</p>
                                                    <p>3. –ö–∞–∂–¥—ã–π –∞–∫–∫–∞—É–Ω—Ç –Ω–∞–ø–∏—à–µ—Ç —Å–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π</p>
                                                    <p>4. –ú—É–∂—Å–∫–∏–µ –∞–∫–∫–∞—É–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –º—É–∂—Å–∫–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</p>
                                                    <p>5. –ñ–µ–Ω—Å–∫–∏–µ –∞–∫–∫–∞—É–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∂–µ–Ω—Å–∫–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</p>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- –ò—Å—Ç–æ—Ä–∏—è –∫–∞–º–ø–∞–Ω–∏–π -->
                            <div class="mt-4">
                                <h6>–ò—Å—Ç–æ—Ä–∏—è –∫–∞–º–ø–∞–Ω–∏–π –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                                <th>–°—Ç–∞—Ç—É—Å</th>
                                                <th>–°–æ–∑–¥–∞–Ω–∞</th>
                                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                            </tr>
                                        </thead>
                                        <tbody id="commentCampaignsTable">
                                            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞
async function updateAccountField(accountId, field, value) {
    try {
        const response = await fetch(`/api/accounts/${accountId}/update_field`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                field: field,
                value: value
            })
        });

        const result = await response.json();
        if (result.success) {
            console.log(`–ü–æ–ª–µ ${field} –æ–±–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞ ${accountId}`);
        } else {
            alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + result.message);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—è');
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≥–µ–Ω–¥–µ—Ä–æ–≤
async function autoAssignGenders() {
    try {
        const response = await fetch('/api/accounts/auto_assign_genders', {
            method: 'POST'
        });

        const result = await response.json();
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + result.message);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è');
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –≤ Telegram
async function updateTelegramProfile(accountId) {
    try {
        const button = document.querySelector(`button[onclick="updateTelegramProfile(${accountId})"]`);
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û–±–Ω–æ–≤–ª—è—é...';
        }

        const response = await fetch(`/api/accounts/${accountId}/update_telegram_profile`, {
            method: 'POST'
        });

        const result = await response.json();
        
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-sync"></i>';
        }
        
        if (result.success) {
            alert('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –≤ Telegram!');
        } else {
            alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ' + result.message);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –≤ Telegram');
        
        const button = document.querySelector(`button[onclick="updateTelegramProfile(${accountId})"]`);
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-sync"></i>';
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è (–∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫—É editProfile is not defined)
async function editProfile(accountId) {
    const first_name = document.querySelector(`#account-${accountId} input[onchange*="first_name"]`).value;
    const last_name = document.querySelector(`#account-${accountId} input[onchange*="last_name"]`).value;
    const bio = document.querySelector(`#account-${accountId} textarea[onchange*="bio"]`).value;
    
    if (!first_name.trim() && !last_name.trim()) {
        alert('–£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –∏–º—è –∏–ª–∏ —Ñ–∞–º–∏–ª–∏—é –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø—Ä–æ—Ñ–∏–ª—è');
        return;
    }
    
    await updateTelegramProfile(accountId);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è
async function uploadProfilePhoto(accountId, input) {
    if (!input.files || !input.files[0]) return;

    const formData = new FormData();
    formData.append('photo', input.files[0]);

    try {
        const response = await fetch(`/api/accounts/${accountId}/upload_photo`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        if (result.success) {
            alert('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
        } else {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: ' + result.message);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ');
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º
document.getElementById('reactionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        name: `–†–µ–∞–∫—Ü–∏–∏ –Ω–∞ ${document.getElementById('reactionPostUrl').value}`,
        post_url: document.getElementById('reactionPostUrl').value,
        reaction_emoji: document.getElementById('reactionEmoji').value,
        delay_seconds: parseInt(document.getElementById('reactionDelay').value)
    };

    try {
        const response = await fetch('/api/reaction_campaigns', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
            alert('–ö–∞–º–ø–∞–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–π –∑–∞–ø—É—â–µ–Ω–∞!');
            document.getElementById('reactionForm').reset();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + result.message);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–ø–∞–Ω–∏–∏: ' + error.message);
    }
});

document.getElementById('viewForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        name: `–ü—Ä–æ—Å–º–æ—Ç—Ä—ã ${document.getElementById('viewPostUrl').value}`,
        post_url: document.getElementById('viewPostUrl').value,
        delay_seconds: parseInt(document.getElementById('viewDelay').value)
    };

    try {
        const response = await fetch('/api/view_campaigns', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
            alert('–ö–∞–º–ø–∞–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∑–∞–ø—É—â–µ–Ω–∞!');
            document.getElementById('viewForm').reset();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + result.message);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–ø–∞–Ω–∏–∏: ' + error.message);
    }
});

document.getElementById('commentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        name: `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ ${document.getElementById('commentPostUrl').value}`,
        post_url: document.getElementById('commentPostUrl').value,
        male_comments: document.getElementById('maleComments').value,
        female_comments: document.getElementById('femaleComments').value,
        delay_seconds: parseInt(document.getElementById('commentDelay').value)
    };

    try {
        const response = await fetch('/api/comment_campaigns', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
            alert('–ö–∞–º–ø–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
            document.getElementById('commentForm').reset();
            loadCommentCampaigns();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + result.message);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–∏: ' + error.message);
    }
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∫–∞–º–ø–∞–Ω–∏–π –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
async function loadCommentCampaigns() {
    try {
        const response = await fetch('/api/comment_campaigns');
        const result = await response.json();
        
        const tbody = document.getElementById('commentCampaignsTable');
        if (result.campaigns) {
            tbody.innerHTML = result.campaigns.map(campaign => `
                <tr>
                    <td>${campaign.name}</td>
                    <td><span class="badge bg-${campaign.status === 'running' ? 'success' : campaign.status === 'completed' ? 'primary' : 'secondary'}">${campaign.status}</span></td>
                    <td>${new Date(campaign.created_at).toLocaleString()}</td>
                    <td>
                        ${campaign.status === 'pending' ? `<button class="btn btn-success btn-sm" onclick="startCommentCampaign(${campaign.id})">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>` : ''}
                        ${campaign.status === 'running' ? `<button class="btn btn-danger btn-sm" onclick="stopCommentCampaign(${campaign.id})">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–ø–∞–Ω–∏–π:', error);
    }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏—è–º–∏ –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
async function startCommentCampaign(campaignId) {
    try {
        const response = await fetch(`/api/comment_campaigns/${campaignId}/start`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            alert('–ö–∞–º–ø–∞–Ω–∏—è –∑–∞–ø—É—â–µ–Ω–∞!');
            loadCommentCampaigns();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + result.message);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–ø–∞–Ω–∏–∏: ' + error.message);
    }
}

async function stopCommentCampaign(campaignId) {
    try {
        const response = await fetch(`/api/comment_campaigns/${campaignId}/stop`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            alert('–ö–∞–º–ø–∞–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!');
            loadCommentCampaigns();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + result.message);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–º–ø–∞–Ω–∏–∏: ' + error.message);
    }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–º–ø–∞–Ω–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadCommentCampaigns();
});
</script>
{% endblock %}
