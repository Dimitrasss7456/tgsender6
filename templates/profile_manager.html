{% extends "base.html" %}

{% block title %}Управление профилями - Telegram Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
    <h1 class="page-title glitch" data-text="УПРАВЛЕНИЕ ПРОФИЛЯМИ">
        <i class="fas fa-user-cog me-3"></i>УПРАВЛЕНИЕ ПРОФИЛЯМИ
    </h1>
    <div class="btn-group">
        <button class="btn btn-primary" onclick="selectByGender('male')">
            <i class="fas fa-mars me-2"></i>Мужские
        </button>
        <button class="btn btn-danger" onclick="selectByGender('female')">
            <i class="fas fa-venus me-2"></i>Женские
        </button>
        <button class="btn btn-success" onclick="selectAll()">
            <i class="fas fa-check-double me-2"></i>Все
        </button>
        <button class="btn btn-secondary" onclick="deselectAll()">
            <i class="fas fa-times me-2"></i>Очистить
        </button>
    </div>
</div>

<div class="row">
    <!-- Панель управления -->
    <div class="col-lg-4 mb-4">
        <div class="row g-3">
            <!-- Автозаполнение -->
            <div class="col-md-6">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-magic me-2"></i>Автозаполнение профилей
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <button class="btn btn-primary w-100" onclick="autoFillProfiles('male')">
                                    <i class="fas fa-mars me-2"></i>Мужские
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-danger w-100" onclick="autoFillProfiles('female')">
                                    <i class="fas fa-venus me-2"></i>Женские
                                </button>
                            </div>
                        </div>
                        <button class="btn btn-success w-100" onclick="updateAllTelegramProfiles()">
                            <i class="fas fa-sync me-2"></i>Обновить в Telegram
                        </button>
                    </div>
                </div>
            </div>

            <!-- Загрузка пользовательских списков -->
            <div class="col-md-6">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-upload me-2"></i>Пользовательские списки
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="customListsAccordion">
                            <!-- Имена -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#namesCollapse">
                                        <i class="fas fa-user me-2"></i>Имена и фамилии
                                    </button>
                                </h2>
                                <div id="namesCollapse" class="accordion-collapse collapse" data-bs-parent="#customListsAccordion">
                                    <div class="accordion-body">
                                        <div class="row g-2 mb-2">
                                            <div class="col-md-6">
                                                <label class="form-label">Мужские имена</label>
                                                <input type="file" class="form-control form-control-sm" accept=".txt" onchange="uploadCustomNames(this, 'male', 'firstnames')">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Женские имена</label>
                                                <input type="file" class="form-control form-control-sm" accept=".txt" onchange="uploadCustomNames(this, 'female', 'firstnames')">
                                            </div>
                                        </div>
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <label class="form-label">Мужские фамилии</label>
                                                <input type="file" class="form-control form-control-sm" accept=".txt" onchange="uploadCustomNames(this, 'male', 'lastnames')">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Женские фамилии</label>
                                                <input type="file" class="form-control form-control-sm" accept=".txt" onchange="uploadCustomNames(this, 'female', 'lastnames')">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Фотографии -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#photosCollapse">
                                        <i class="fas fa-images me-2"></i>Фотографии профилей
                                    </button>
                                </h2>
                                <div id="photosCollapse" class="accordion-collapse collapse" data-bs-parent="#customListsAccordion">
                                    <div class="accordion-body">
                                        <div class="row g-2 mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Мужские фото</label>
                                                <input type="file" class="form-control form-control-sm" accept="image/*" multiple onchange="uploadCustomPhotos(this, 'male')">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Женские фото</label>
                                                <input type="file" class="form-control form-control-sm" accept="image/*" multiple onchange="uploadCustomPhotos(this, 'female')">
                                            </div>
                                        </div>
                                        <div class="alert alert-info mb-0">
                                            <small>
                                                <strong>Как использовать:</strong><br>
                                                1. Загрузите txt файлы с именами (по одному на строку)<br>
                                                2. Загрузите фотографии (PNG, JPG)<br>
                                                3. Нажмите "Автозаполнение" - система будет использовать ваши списки<br>
                                                4. Username создается автоматически из имени и фамилии
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Комментирование -->
            <div class="col-12">
                <div class="card fade-in">
                    <div class="card-header">
                        <i class="fas fa-comments me-2"></i>КОММЕНТИРОВАНИЕ
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-link me-2"></i>Ссылка на пост
                            </label>
                            <input type="url" class="form-control" id="commentPostUrl"
                                   placeholder="https://t.me/channel/123">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-mars text-primary me-2"></i>Мужские комментарии
                            </label>
                            <textarea class="form-control" id="maleCommentsList" rows="3"
                                      placeholder="Один комментарий на строку"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-venus text-danger me-2"></i>Женские комментарии
                            </label>
                            <textarea class="form-control" id="femaleCommentsList" rows="3"
                                      placeholder="Один комментарий на строку"></textarea>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label">
                                    <i class="fas fa-clock me-2"></i>Задержка (сек)
                                </label>
                                <input type="number" class="form-control" id="commentDelay" value="60" min="30">
                            </div>
                            <div class="col-6">
                                <label class="form-label">
                                    <i class="fas fa-shield-alt me-2"></i>Режим
                                </label>
                                <select class="form-control" id="antispamMode">
                                    <option value="safe">Безопасный</option>
                                    <option value="normal">Обычный</option>
                                    <option value="fast">Быстрый</option>
                                </select>
                            </div>
                        </div>

                        <button class="btn btn-success w-100" onclick="startSequentialComments()">
                            <i class="fas fa-paper-plane me-2"></i>Запустить комментарии
                        </button>
                    </div>
                </div>
            </div>

            <!-- Реакции -->
            <div class="col-12">
                <div class="card fade-in">
                    <div class="card-header">
                        <i class="fas fa-heart me-2"></i>РЕАКЦИИ
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-link me-2"></i>Ссылка на пост
                            </label>
                            <input type="url" class="form-control" id="reactionPostUrl"
                                   placeholder="https://t.me/channel/123">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-smile me-2"></i>Выберите реакции
                            </label>
                            <div class="d-flex flex-wrap gap-2" id="reactionSelector">
                                <span class="reaction-selector" data-emoji="👍">👍</span>
                                <span class="reaction-selector" data-emoji="❤️">❤️</span>
                                <span class="reaction-selector" data-emoji="🔥">🔥</span>
                                <span class="reaction-selector" data-emoji="👏">👏</span>
                                <span class="reaction-selector" data-emoji="😂">😂</span>
                                <span class="reaction-selector" data-emoji="👎">👎</span>
                                <span class="reaction-selector" data-emoji="😮">😮</span>
                                <span class="reaction-selector" data-emoji="😢">😢</span>
                            </div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label">
                                    <i class="fas fa-hashtag me-2"></i>Количество
                                </label>
                                <input type="number" class="form-control" id="totalReactions" value="9" min="1">
                            </div>
                            <div class="col-6">
                                <label class="form-label">
                                    <i class="fas fa-clock me-2"></i>Задержка (сек)
                                </label>
                                <input type="number" class="form-control" id="reactionDelay" value="20" min="5">
                            </div>
                        </div>

                        <button class="btn btn-warning w-100" onclick="startMultipleReactions()">
                            <i class="fas fa-rocket me-2"></i>Запустить реакции
                        </button>
                    </div>
                </div>
            </div>

            <!-- Накрутка просмотров -->
            <div class="col-12">
                <div class="card fade-in">
                    <div class="card-header">
                        <i class="fas fa-eye me-2"></i>НАКРУТКА ПРОСМОТРОВ
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-link me-2"></i>Ссылка на пост
                            </label>
                            <input type="url" class="form-control" id="viewPostUrl"
                                   placeholder="https://t.me/channel/123">
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label">
                                    <i class="fas fa-hashtag me-2"></i>Количество просмотров
                                </label>
                                <input type="number" class="form-control" id="viewCount" value="50" min="1" max="1000">
                            </div>
                            <div class="col-6">
                                <label class="form-label">
                                    <i class="fas fa-clock me-2"></i>Задержка (сек)
                                </label>
                                <input type="number" class="form-control" id="viewDelay" value="10" min="1">
                            </div>
                        </div>

                        <button class="btn btn-success w-100" onclick="startPostViews()">
                            <i class="fas fa-eye me-2"></i>Запустить просмотры
                        </button>
                    </div>
                </div>
            </div>

            <!-- Управление комментариями -->
            <div class="col-12">
                <div class="card fade-in">
                    <div class="card-header">
                        <i class="fas fa-comment-dots me-2"></i>УПРАВЛЕНИЕ КОММЕНТАРИЯМИ
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button class="btn btn-info w-100" onclick="showCommentHistory()">
                                <i class="fas fa-history me-2"></i>Показать историю комментариев
                            </button>
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-danger w-100" onclick="clearAllComments()">
                                <i class="fas fa-trash-alt me-2"></i>Очистить всю историю
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Список аккаунтов -->
    <div class="col-lg-8">
        <div class="card fade-in">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-users me-2"></i>АККАУНТЫ ({{ accounts|length }})
                </span>
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary me-2" id="selectedCount">0 выбрано</span>
                </div>
            </div>
            <div class="card-body p-3">
                <div id="alerts"></div>

                <div class="row g-3" id="accountsContainer">
                    {% for account in accounts %}
                    <div class="col-xl-4 col-lg-6 col-md-6">
                        <div class="card account-card {% if account.gender == 'male' %}border-primary{% elif account.gender == 'female' %}border-danger{% else %}border-secondary{% endif %}"
                             id="account-{{ account.id }}"
                             onclick="toggleAccountSelection({{ account.id }})">

                            <div class="card-header p-2 d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <input type="checkbox" class="form-check-input account-checkbox me-2"
                                           id="checkbox-{{ account.id }}"
                                           onclick="event.stopPropagation()">

                                    {% if account.gender == 'male' %}
                                        <i class="fas fa-mars text-primary me-2"></i>
                                    {% elif account.gender == 'female' %}
                                        <i class="fas fa-venus text-danger me-2"></i>
                                    {% else %}
                                        <i class="fas fa-question text-secondary me-2"></i>
                                    {% endif %}

                                    <small class="badge bg-{{ 'success' if account.is_active else 'danger' }}">
                                        {{ account.phone }}
                                    </small>
                                </div>

                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary btn-sm"
                                            onclick="event.stopPropagation(); editAccount({{ account.id }})"
                                            title="Редактировать">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-success btn-sm"
                                            onclick="event.stopPropagation(); updateTelegramProfile({{ account.id }})"
                                            title="Обновить в Telegram">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="card-body p-3">
                                <div class="mb-2">
                                    <strong class="text-white">
                                        {{ account.first_name or 'Без имени' }} {{ account.last_name or '' }}
                                    </strong>
                                </div>

                                {% if account.bio %}
                                <p class="small text-muted mb-2">
                                    {{ account.bio[:40] }}{% if account.bio|length > 40 %}...{% endif %}
                                </p>
                                {% endif %}

                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-{{ 'success' if account.status == 'online' else 'secondary' }}">
                                        {{ account.status }}
                                    </span>
                                    {% if account.gender %}
                                    <span class="badge bg-{{ 'primary' if account.gender == 'male' else 'danger' }}">
                                        {{ 'Мужской' if account.gender == 'male' else 'Женский' }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования -->
<div class="modal fade" id="editAccountModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit me-2"></i>РЕДАКТИРОВАНИЕ АККАУНТА
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editAccountForm">
                    <input type="hidden" id="editAccountId">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-user me-2"></i>Имя
                            </label>
                            <input type="text" class="form-control" id="editFirstName" placeholder="Введите имя">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-user me-2"></i>Фамилия
                            </label>
                            <input type="text" class="form-control" id="editLastName" placeholder="Введите фамилию">
                        </div>
                    </div>

                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-venus-mars me-2"></i>Гендер
                            </label>
                            <select class="form-control" id="editGender">
                                <option value="">Не указан</option>
                                <option value="male">Мужской</option>
                                <option value="female">Женский</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-image me-2"></i>Фото профиля
                            </label>
                            <input type="file" class="form-control" id="editPhoto" accept="image/*">
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">
                            <i class="fas fa-info-circle me-2"></i>О себе
                        </label>
                        <textarea class="form-control" id="editBio" rows="3" placeholder="Расскажите о себе..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Отмена
                </button>
                <button type="button" class="btn btn-primary" onclick="saveAccountChanges()">
                    <i class="fas fa-save me-2"></i>Сохранить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно истории комментариев -->
<div class="modal fade" id="commentHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-history me-2"></i>ИСТОРИЯ КОММЕНТАРИЕВ
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="commentHistoryContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Загрузка истории комментариев...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Закрыть
                </button>
                <button type="button" class="btn btn-danger" onclick="clearAccountComments()">
                    <i class="fas fa-trash-alt me-2"></i>Очистить историю
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.account-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border-width: 2px !important;
    background: var(--cyber-bg-card);
    overflow: hidden;
    position: relative;
}

.account-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--cyber-primary), var(--cyber-secondary), var(--cyber-accent));
    opacity: 0.7;
}

.account-card:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: var(--cyber-shadow-strong);
}

.account-card.selected {
    border-color: var(--cyber-primary) !important;
    box-shadow: var(--cyber-glow-strong) var(--cyber-primary);
    transform: translateY(-3px) scale(1.02);
}

.reaction-selector {
    cursor: pointer;
    padding: 8px 12px;
    border: 2px solid var(--cyber-border);
    border-radius: 10px;
    background: var(--cyber-bg-secondary);
    transition: all 0.3s ease;
    font-size: 18px;
    display: inline-block;
}

.reaction-selector:hover {
    border-color: var(--cyber-primary);
    box-shadow: var(--cyber-glow) var(--cyber-primary);
    transform: scale(1.1);
}

.reaction-selector.selected {
    background: var(--cyber-primary);
    border-color: var(--cyber-primary);
    box-shadow: var(--cyber-glow-strong) var(--cyber-primary);
}

.border-primary {
    border-color: var(--cyber-primary) !important;
}

.border-danger {
    border-color: var(--cyber-danger) !important;
}

.border-secondary {
    border-color: var(--cyber-border) !important;
}
</style>

<script>
let selectedAccounts = new Set();

function selectByGender(gender) {
    const cards = document.querySelectorAll('.account-card');
    cards.forEach(card => {
        const accountId = parseInt(card.id.replace('account-', ''));
        const checkbox = document.getElementById(`checkbox-${accountId}`);
        const genderIcon = card.querySelector('.fa-mars, .fa-venus');

        let shouldSelect = false;
        if (gender === 'male' && genderIcon && genderIcon.classList.contains('fa-mars')) {
            shouldSelect = true;
        } else if (gender === 'female' && genderIcon && genderIcon.classList.contains('fa-venus')) {
            shouldSelect = true;
        }

        if (shouldSelect) {
            checkbox.checked = true;
            selectedAccounts.add(accountId);
            card.classList.add('selected');
        }
    });

    updateSelectedCount();
}

function selectAll() {
    const checkboxes = document.querySelectorAll('.account-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        const accountId = parseInt(checkbox.id.replace('checkbox-', ''));
        selectedAccounts.add(accountId);
        document.getElementById(`account-${accountId}`).classList.add('selected');
    });

    updateSelectedCount();
}

function deselectAll() {
    const checkboxes = document.querySelectorAll('.account-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        const accountId = parseInt(checkbox.id.replace('checkbox-', ''));
        selectedAccounts.delete(accountId);
        document.getElementById(`account-${accountId}`).classList.remove('selected');
    });

    selectedAccounts.clear();
    updateSelectedCount();
}

function editAccount(accountId) {
    // Получаем данные аккаунта
    fetch(`/api/accounts/${accountId}`)
        .then(response => response.json())
        .then(data => {
            // Заполняем форму
            document.getElementById('editAccountId').value = accountId;
            document.getElementById('editFirstName').value = data.first_name || '';
            document.getElementById('editLastName').value = data.last_name || '';
            document.getElementById('editGender').value = data.gender || '';
            document.getElementById('editBio').value = data.bio || '';

            // Показываем модальное окно
            const modal = new bootstrap.Modal(document.getElementById('editAccountModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Ошибка получения данных аккаунта:', error);
            showAlert('Ошибка загрузки данных аккаунта', 'danger');
        });
}

function showAlert(message, type = 'info') {
    const alertsContainer = document.getElementById('alerts');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertsContainer.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

function updateSelectedCount() {
    const count = selectedAccounts.size;
    const countElement = document.getElementById('selectedCount');
    if (countElement) {
        countElement.textContent = `${count} выбрано`;
        countElement.className = `badge ${count > 0 ? 'bg-primary' : 'bg-secondary'} me-2`;
    }

    // Обновляем состояние кнопок
    const actionButtons = document.querySelectorAll('.action-btn');
    actionButtons.forEach(btn => {
        btn.disabled = count === 0;
    });

    console.log('📊 Текущие выбранные аккаунты:', Array.from(selectedAccounts));
}

function toggleAccountSelection(accountId) {
    const checkbox = document.getElementById(`checkbox-${accountId}`);
    if (!checkbox) return;

    checkbox.checked = !checkbox.checked;

    if (checkbox.checked) {
        selectedAccounts.add(parseInt(accountId));
        document.getElementById(`account-${accountId}`).classList.add('selected');
    } else {
        selectedAccounts.delete(parseInt(accountId));
        document.getElementById(`account-${accountId}`).classList.remove('selected');
    }

    updateSelectedCount();
}

async function saveAccountChanges() {
    const accountId = document.getElementById('editAccountId').value;
    const firstName = document.getElementById('editFirstName').value;
    const lastName = document.getElementById('editLastName').value;
    const gender = document.getElementById('editGender').value;
    const bio = document.getElementById('editBio').value;
    const photoFile = document.getElementById('editPhoto').files[0];

    try {
        const formData = new FormData();
        formData.append('first_name', firstName);
        formData.append('last_name', lastName);
        formData.append('gender', gender);
        formData.append('bio', bio);

        if (photoFile) {
            formData.append('photo', photoFile);
        }

        const response = await fetch(`/api/accounts/${accountId}/update`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            showAlert('Аккаунт обновлен успешно', 'success');

            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('editAccountModal'));
            modal.hide();

            // Перезагружаем страницу через секунду
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Ошибка: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('Ошибка сети: ' + error.message, 'danger');
    }
}

function toggleAllAccounts() {
    const masterCheckbox = document.getElementById('selectAll');
    const accountCheckboxes = document.querySelectorAll('input[data-account-id]');

    accountCheckboxes.forEach(checkbox => {
        checkbox.checked = masterCheckbox.checked;
        const accountId = parseInt(checkbox.getAttribute('data-account-id'));

        if (masterCheckbox.checked) {
            selectedAccounts.add(accountId);
        } else {
            selectedAccounts.delete(accountId);
        }
    });

    updateSelectedCount();
}

async function updateAccountField(accountId, field, value) {
    try {
        const response = await fetch(`/api/accounts/${accountId}/update_field`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ field: field, value: value })
        });

        const result = await response.json();
        if (result.success) {
            showAlert('Поле обновлено', 'success');
        } else {
            showAlert('Ошибка: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('Ошибка сети: ' + error.message, 'danger');
    }
}

async function autoFillProfiles(gender) {
    try {
        showAlert('Обновление профилей...', 'info');

        const response = await fetch('/api/accounts/auto_assign_genders', {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            showAlert(`✅ Успешно обновлено ${result.updated_count} профилей с использованием ваших списков`, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('Ошибка: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('Ошибка: ' + error.message, 'danger');
    }
}

async function uploadCustomNames(input, gender, nameType) {
    const file = input.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('gender', gender);
    formData.append('name_type', nameType);

    try {
        const response = await fetch('/api/upload_custom_names', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (result.success) {
            showAlert(`Файл с ${nameType} для ${gender} успешно загружен`, 'success');
        } else {
            showAlert(`Ошибка загрузки ${nameType}: ${result.message}`, 'danger');
        }
    } catch (error) {
        showAlert(`Ошибка сети при загрузке ${nameType}: ${error.message}`, 'danger');
    }
}

async function uploadCustomPhotos(input, gender) {
    const files = input.files;
    if (!files || files.length === 0) return;

    const formData = new FormData();
    formData.append('gender', gender);
    for (let i = 0; i < files.length; i++) {
        formData.append('photos', files[i]);
    }

    try {
        const response = await fetch('/api/upload_custom_photos', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (result.success) {
            showAlert(`Фотографии для ${gender} успешно загружены (${result.count} файлов)`, 'success');
        } else {
            showAlert(`Ошибка загрузки фотографий: ${result.message}`, 'danger');
        }
    } catch (error) {
        showAlert(`Ошибка сети при загрузке фотографий: ${error.message}`, 'danger');
    }
}


async function uploadProfilePhoto(accountId) {
    const fileInput = document.getElementById(`photoUpload${accountId}`);
    const file = fileInput.files[0];

    if (!file) {
        showAlert('Выберите файл', 'warning');
        return;
    }

    const formData = new FormData();
    formData.append('photo', file);

    try {
        const response = await fetch(`/api/accounts/${accountId}/upload_photo`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        if (result.success) {
            showAlert('Фото загружено', 'success');
        } else {
            showAlert('Ошибка: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('Ошибка: ' + error.message, 'danger');
    }
}

async function updateTelegramProfile(accountId) {
    try {
        const response = await fetch(`/api/accounts/${accountId}/update_telegram_profile`, {
            method: 'POST'
        });

        const result = await response.json();
        if (result.success) {
            showAlert('Профиль обновлен в Telegram', 'success');
        } else {
            showAlert('Ошибка: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('Ошибка: ' + error.message, 'danger');
    }
}

async function updateAllTelegramProfiles() {
    if (selectedAccounts.size === 0) {
        showAlert('Выберите аккаунты', 'warning');
        return;
    }

    try {
        const response = await fetch('/api/accounts/update_all_telegram_profiles', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                account_ids: Array.from(selectedAccounts)
            })
        });

        const result = await response.json();
        if (result.success) {
            showAlert(`Обновлено профилей: ${result.updated_count}`, 'success');
        } else {
            showAlert('Ошибка: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('Ошибка: ' + error.message, 'danger');
    }
}

// Комментирование постов
async function startSequentialComments() {
    console.log('🔍 Отладка выбранных аккаунтов:', Array.from(selectedAccounts));

    if (selectedAccounts.size === 0) {
        showAlert('Выберите хотя бы один аккаунт', 'warning');
        return;
    }

    const postUrl = document.getElementById('commentPostUrl').value;
    const maleComments = document.getElementById('maleCommentsList').value;
    const femaleComments = document.getElementById('femaleCommentsList').value;
    const delaySeconds = parseInt(document.getElementById('commentDelay').value) || 3;
    const antispamMode = document.getElementById('antispamMode').value;

    if (!postUrl) {
        showAlert('Введите URL поста', 'warning');
        return;
    }

    if (!maleComments && !femaleComments) {
        showAlert('Введите комментарии', 'warning');
        return;
    }

    // Парсим URL поста
    const urlMatch = postUrl.match(/t\.me\/([^\/]+)\/(\d+)/);
    if (!urlMatch) {
        showAlert('Неверный формат URL. Используйте формат: https://t.me/channel/123', 'danger');
        return;
    }

    const chatId = `@${urlMatch[1]}`;
    const messageId = parseInt(urlMatch[2]);

    // Разбиваем комментарии на массивы
    const maleCommentsArray = maleComments.split('\n').filter(c => c.trim());
    const femaleCommentsArray = femaleComments.split('\n').filter(c => c.trim());

    console.log('📝 Отправляем запрос с аккаунтом:', Array.from(selectedAccounts)[0]);

    // Формируем цели для комментирования (пока используем первый аккаунт)
    const targets = [];
    const selectedAccountsArray = Array.from(selectedAccounts);

    // Берем случайный комментарий из доступных
    const allComments = [...maleCommentsArray, ...femaleCommentsArray];
    if (allComments.length > 0) {
        const randomComment = allComments[Math.floor(Math.random() * allComments.length)];
        targets.push({
            chat_id: chatId,
            message_id: messageId,
            comment: randomComment
        });
    }

    try {
        const response = await fetch('/api/sequential_comments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                account_id: selectedAccountsArray[0], // Используем первый выбранный аккаунт
                targets: targets,
                delay_seconds: delaySeconds
            })
        });

        const result = await response.json();
        if (result.success) {
            showAlert(result.message, 'success');

            // Автоматически обновляем историю комментариев если модальное окно открыто
            const modal = document.getElementById('commentHistoryModal');
            if (modal && modal.classList.contains('show')) {
                console.log('🔄 Обновляем историю комментариев после отправки');
                setTimeout(() => {
                    showCommentHistory();
                }, 2000); // Задержка 2 секунды для обновления БД
            }
        } else {
            showAlert('Ошибка: ' + result.message, 'danger');
        }
    } catch (error) {
        console.error('❌ Ошибка отправки комментария:', error);
        showAlert('Ошибка отправки комментария: ' + error.message, 'danger');
    }
}


// Управление комментариями
let currentAccountIdForComments = null;

async function showCommentHistory() {
    if (selectedAccounts.size === 0) {
        showAlert('Выберите аккаунт для просмотра истории комментариев', 'warning');
        return;
    }

    const accountId = Array.from(selectedAccounts)[0];
    currentAccountIdForComments = accountId;

    const modal = new bootstrap.Modal(document.getElementById('commentHistoryModal'));
    modal.show();

    // Показываем индикатор загрузки
    document.getElementById('commentHistoryContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <p class="mt-2">Загрузка истории комментариев...</p>
        </div>
    `;

    try {
        const response = await fetch(`/api/comments/history/${accountId}?_t=${Date.now()}`);
        const result = await response.json();

        console.log('История комментариев:', result);

        if (result.success) {
            displayCommentHistory(result.comments);
        } else {
            document.getElementById('commentHistoryContent').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${result.message || 'Не удалось загрузить историю комментариев'}
                </div>
            `;
        }
    } catch (error) {
        console.error('Ошибка загрузки истории:', error);
        document.getElementById('commentHistoryContent').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                Ошибка загрузки: ${error.message}
            </div>
        `;
    }
}

function displayCommentHistory(comments) {
    const content = document.getElementById('commentHistoryContent');

    if (!comments || comments.length === 0) {
        content.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                История комментариев пуста
            </div>
        `;
        return;
    }

    let html = `
        <div class="mb-3">
            <span class="badge bg-primary">Всего комментариев: ${comments.length}</span>
        </div>
        <div class="table-responsive">
            <table class="table table-dark table-striped">
                <thead>
                    <tr>
                        <th>Дата</th>
                        <th>Канал/Чат</th>
                        <th>Комментарий</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
    `;

    comments.forEach(comment => {
        const date = comment.sent_at ? new Date(comment.sent_at).toLocaleString('ru-RU') : 'Неизвестно';
        const status = comment.status === 'sent' ?
            '<span class="badge bg-success">Отправлен</span>' :
            '<span class="badge bg-danger">Ошибка</span>';

        const commentText = comment.comment.length > 50 ?
            comment.comment.substring(0, 50) + '...' :
            comment.comment;

        html += `
            <tr id="comment-row-${comment.id}">
                <td>${date}</td>
                <td>${comment.chat_id}</td>
                <td title="${comment.comment}">${commentText}</td>
                <td>${status}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteComment(${comment.id})" title="Удалить комментарий">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    content.innerHTML = html;
}

async function deleteComment(commentId) {
    if (!confirm('Вы уверены, что хотите удалить этот комментарий?')) {
        return;
    }

    try {
        const response = await fetch(`/api/comments/${commentId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            showAlert(result.message, 'success');

            // Удаляем строку из таблицы
            const row = document.getElementById(`comment-row-${commentId}`);
            if (row) {
                row.remove();
            }
        } else {
            showAlert('Ошибка: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('Ошибка удаления: ' + error.message, 'danger');
    }
}

async function clearAccountComments() {
    if (!currentAccountIdForComments) {
        showAlert('Аккаунт не выбран', 'warning');
        return;
    }

    if (!confirm('Вы уверены, что хотите очистить всю историю комментариев этого аккаунта?')) {
        return;
    }

    try {
        const response = await fetch(`/api/comments/clear/${currentAccountIdForComments}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            showAlert(result.message, 'success');

            // Обновляем содержимое модального окна
            document.getElementById('commentHistoryContent').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    История комментариев очищена
                </div>
            `;
        } else {
            showAlert('Ошибка: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('Ошибка очистки: ' + error.message, 'danger');
    }
}

async function clearAllComments() {
    if (selectedAccounts.size === 0) {
        showAlert('Выберите аккаунты для очистки истории комментариев', 'warning');
        return;
    }

    if (!confirm(`Вы уверены, что хотите очистить историю комментариев для ${selectedAccounts.size} аккаунтов?`)) {
        return;
    }

    let clearedCount = 0;
    const totalAccounts = selectedAccounts.size;

    for (const accountId of selectedAccounts) {
        try {
            const response = await fetch(`/api/comments/clear/${accountId}`, {
                method: 'DELETE'
            });

            const result = await response.json();
            if (result.success) {
                clearedCount++;
            }
        } catch (error) {
            console.error(`Ошибка очистки для аккаунта ${accountId}:`, error);
        }
    }

    showAlert(`История комментариев очищена для ${clearedCount} из ${totalAccounts} аккаунтов`, 'success');
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    updateSelectedCount();

    // Добавляем обработчики для чекбоксов
    document.querySelectorAll('.account-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function(e) {
            e.stopPropagation();
            const accountId = parseInt(this.id.replace('checkbox-', ''));
            const card = document.getElementById(`account-${accountId}`);

            if (this.checked) {
                selectedAccounts.add(accountId);
                card.classList.add('selected');
            } else {
                selectedAccounts.delete(accountId);
                card.classList.remove('selected');
            }

            updateSelectedCount();
        });
    });
});

// Обработчик для выбора реакций
document.querySelectorAll('.reaction-selector').forEach(selector => {
    selector.addEventListener('click', function() {
        this.classList.toggle('selected');
        updateReactionButtonState(); // Обновляем состояние кнопки при выборе/снятии реакции
    });
});

// Функция для обновления состояния кнопки "Запустить реакции"
function updateReactionButtonState() {
    const selectedReactions = document.querySelectorAll('.reaction-selector.selected');
    const startButton = document.querySelector('.btn-warning[onclick="startMultipleReactions()"]');
    if (startButton) {
        startButton.disabled = selectedReactions.length === 0;
    }
}


// Функция для запуска нескольких реакций
async function startMultipleReactions() {
    if (selectedAccounts.size === 0) {
        showAlert('Выберите аккаунты для реакций', 'warning');
        return;
    }

    const postUrl = document.getElementById('reactionPostUrl').value.trim();
    const totalReactions = parseInt(document.getElementById('totalReactions').value) || 1;
    const delaySeconds = parseInt(document.getElementById('reactionDelay').value) || 20;

    if (!postUrl) {
        showAlert('Введите URL поста для реакций', 'warning');
        return;
    }

    // Собираем выбранные реакции из кнопок
    const selectedReactionButtons = document.querySelectorAll('.reaction-selector.selected');
    const selectedReactions = Array.from(selectedReactionButtons).map(btn => btn.dataset.emoji);

    if (selectedReactions.length === 0) {
        showAlert('Выберите хотя бы одну реакцию', 'warning');
        return;
    }

    console.log('Отправляем реакции:', {
        post_url: postUrl,
        reactions: selectedReactions,
        total_count: totalReactions,
        selected_accounts: Array.from(selectedAccounts),
        delay_seconds: delaySeconds
    });

    try {
        const response = await fetch('/api/multiple_reactions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                post_url: postUrl,
                reactions: selectedReactions,
                total_count: totalReactions,
                selected_accounts: Array.from(selectedAccounts),
                delay_seconds: delaySeconds
            })
        });

        const result = await response.json();

        if (result.success) {
            showAlert(`Реакции запущены! Будет отправлено ${totalReactions} реакций с задержкой ${delaySeconds} секунд`, 'success');
        } else {
            showAlert('Ошибка запуска реакций: ' + result.message, 'danger');
        }
    } catch (error) {
        console.error('Ошибка запуска реакций:', error);
        showAlert('Ошибка сети: ' + error.message, 'danger');
    }
}

// Функция для запуска накрутки просмотров
async function startPostViews() {
    if (selectedAccounts.size === 0) {
        showAlert('Выберите аккаунты для накрутки просмотров', 'warning');
        return;
    }

    const postUrl = document.getElementById('viewPostUrl').value.trim();
    const viewCount = parseInt(document.getElementById('viewCount').value) || 10;
    const delaySeconds = parseInt(document.getElementById('viewDelay').value) || 10;

    if (!postUrl) {
        showAlert('Введите URL поста для просмотров', 'warning');
        return;
    }

    // Валидация URL
    const urlPattern = /t\.me\/([^\/]+)\/(\d+)/;
    const urlMatch = postUrl.match(urlPattern);
    if (!urlMatch) {
        showAlert('Неверный формат URL. Используйте формат: https://t.me/channel/123', 'danger');
        return;
    }

    // Ограничиваем количество аккаунтов количеством просмотров
    const accountsToUse = Math.min(selectedAccounts.size, viewCount);

    console.log('Запускаем просмотры:', {
        post_url: postUrl,
        view_count: viewCount,
        selected_accounts: Array.from(selectedAccounts),
        delay_seconds: delaySeconds,
        accounts_to_use: accountsToUse
    });

    try {
        const response = await fetch('/api/post_views', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                post_url: postUrl,
                view_count: viewCount,
                selected_accounts: Array.from(selectedAccounts),
                delay_seconds: delaySeconds
            })
        });

        const result = await response.json();

        if (result.success) {
            showAlert(`Накрутка просмотров запущена! Будет использовано ${accountsToUse} аккаунтов с задержкой ${delaySeconds} секунд`, 'success');
        } else {
            showAlert('Ошибка запуска просмотров: ' + result.message, 'danger');
        }
    } catch (error) {
        console.error('Ошибка запуска просмотров:', error);
        showAlert('Ошибка сети: ' + error.message, 'danger');
    }
}
</script>
{% endblock %}