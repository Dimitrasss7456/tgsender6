{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è–º–∏ - Telegram Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
    <h1 class="page-title glitch" data-text="–£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–§–ò–õ–Ø–ú–ò">
        <i class="fas fa-user-cog me-3"></i>–£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–§–ò–õ–Ø–ú–ò
    </h1>
    <div class="btn-group">
        <button class="btn btn-primary" onclick="selectByGender('male')">
            <i class="fas fa-mars me-2"></i>–ú—É–∂—Å–∫–∏–µ
        </button>
        <button class="btn btn-danger" onclick="selectByGender('female')">
            <i class="fas fa-venus me-2"></i>–ñ–µ–Ω—Å–∫–∏–µ
        </button>
        <button class="btn btn-success" onclick="selectAll()">
            <i class="fas fa-check-double me-2"></i>–í—Å–µ
        </button>
        <button class="btn btn-secondary" onclick="deselectAll()">
            <i class="fas fa-times me-2"></i>–û—á–∏—Å—Ç–∏—Ç—å
        </button>
    </div>
</div>

<div class="row">
    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="col-lg-4 mb-4">
        <div class="row g-3">
            <!-- –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ -->
            <div class="col-md-6">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-magic me-2"></i>–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <button class="btn btn-primary w-100" onclick="autoFillProfiles('male')">
                                    <i class="fas fa-mars me-2"></i>–ú—É–∂—Å–∫–∏–µ
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-danger w-100" onclick="autoFillProfiles('female')">
                                    <i class="fas fa-venus me-2"></i>–ñ–µ–Ω—Å–∫–∏–µ
                                </button>
                            </div>
                        </div>
                        <button class="btn btn-success w-100" onclick="updateAllTelegramProfiles()">
                            <i class="fas fa-sync me-2"></i>–û–±–Ω–æ–≤–∏—Ç—å –≤ Telegram
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–ø–∏—Å–∫–æ–≤ -->
            <div class="col-md-6">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-upload me-2"></i>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–ø–∏—Å–∫–∏
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="customListsAccordion">
                            <!-- –ò–º–µ–Ω–∞ -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#namesCollapse">
                                        <i class="fas fa-user me-2"></i>–ò–º–µ–Ω–∞ –∏ —Ñ–∞–º–∏–ª–∏–∏
                                    </button>
                                </h2>
                                <div id="namesCollapse" class="accordion-collapse collapse" data-bs-parent="#customListsAccordion">
                                    <div class="accordion-body">
                                        <div class="row g-2 mb-2">
                                            <div class="col-md-6">
                                                <label class="form-label">–ú—É–∂—Å–∫–∏–µ –∏–º–µ–Ω–∞</label>
                                                <input type="file" class="form-control form-control-sm" accept=".txt" onchange="uploadCustomNames(this, 'male', 'firstnames')">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">–ñ–µ–Ω—Å–∫–∏–µ –∏–º–µ–Ω–∞</label>
                                                <input type="file" class="form-control form-control-sm" accept=".txt" onchange="uploadCustomNames(this, 'female', 'firstnames')">
                                            </div>
                                        </div>
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <label class="form-label">–ú—É–∂—Å–∫–∏–µ —Ñ–∞–º–∏–ª–∏–∏</label>
                                                <input type="file" class="form-control form-control-sm" accept=".txt" onchange="uploadCustomNames(this, 'male', 'lastnames')">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">–ñ–µ–Ω—Å–∫–∏–µ —Ñ–∞–º–∏–ª–∏–∏</label>
                                                <input type="file" class="form-control form-control-sm" accept=".txt" onchange="uploadCustomNames(this, 'female', 'lastnames')">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#photosCollapse">
                                        <i class="fas fa-images me-2"></i>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π
                                    </button>
                                </h2>
                                <div id="photosCollapse" class="accordion-collapse collapse" data-bs-parent="#customListsAccordion">
                                    <div class="accordion-body">
                                        <div class="row g-2 mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">–ú—É–∂—Å–∫–∏–µ —Ñ–æ—Ç–æ</label>
                                                <input type="file" class="form-control form-control-sm" accept="image/*" multiple onchange="uploadCustomPhotos(this, 'male')">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">–ñ–µ–Ω—Å–∫–∏–µ —Ñ–æ—Ç–æ</label>
                                                <input type="file" class="form-control form-control-sm" accept="image/*" multiple onchange="uploadCustomPhotos(this, 'female')">
                                            </div>
                                        </div>
                                        <div class="alert alert-info mb-0">
                                            <small>
                                                <strong>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</strong><br>
                                                1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ txt —Ñ–∞–π–ª—ã —Å –∏–º–µ–Ω–∞–º–∏ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)<br>
                                                2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (PNG, JPG)<br>
                                                3. –ù–∞–∂–º–∏—Ç–µ "–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ" - —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–∞—à–∏ —Å–ø–∏—Å–∫–∏<br>
                                                4. Username —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∏–º–µ–Ω–∏ –∏ —Ñ–∞–º–∏–ª–∏–∏
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ -->
            <div class="col-12">
                <div class="card fade-in">
                    <div class="card-header">
                        <i class="fas fa-comments me-2"></i>–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–ù–ò–ï
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-link me-2"></i>–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç
                            </label>
                            <input type="url" class="form-control" id="commentPostUrl"
                                   placeholder="https://t.me/channel/123">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-mars text-primary me-2"></i>–ú—É–∂—Å–∫–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                            </label>
                            <textarea class="form-control" id="maleCommentsList" rows="3"
                                      placeholder="–û–¥–∏–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ —Å—Ç—Ä–æ–∫—É"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-venus text-danger me-2"></i>–ñ–µ–Ω—Å–∫–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                            </label>
                            <textarea class="form-control" id="femaleCommentsList" rows="3"
                                      placeholder="–û–¥–∏–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ —Å—Ç—Ä–æ–∫—É"></textarea>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label">
                                    <i class="fas fa-clock me-2"></i>–ó–∞–¥–µ—Ä–∂–∫–∞ (—Å–µ–∫)
                                </label>
                                <input type="number" class="form-control" id="commentDelay" value="60" min="30">
                            </div>
                            <div class="col-6">
                                <label class="form-label">
                                    <i class="fas fa-shield-alt me-2"></i>–†–µ–∂–∏–º
                                </label>
                                <select class="form-control" id="antispamMode">
                                    <option value="safe">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π</option>
                                    <option value="normal">–û–±—ã—á–Ω—ã–π</option>
                                    <option value="fast">–ë—ã—Å—Ç—Ä—ã–π</option>
                                </select>
                            </div>
                        </div>

                        <button class="btn btn-success w-100" onclick="startSequentialComments()">
                            <i class="fas fa-paper-plane me-2"></i>–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                        </button>
                    </div>
                </div>
            </div>

            <!-- –†–µ–∞–∫—Ü–∏–∏ -->
            <div class="col-12">
                <div class="card fade-in">
                    <div class="card-header">
                        <i class="fas fa-heart me-2"></i>–†–ï–ê–ö–¶–ò–ò
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-link me-2"></i>–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç
                            </label>
                            <input type="url" class="form-control" id="reactionPostUrl"
                                   placeholder="https://t.me/channel/123">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-smile me-2"></i>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∞–∫—Ü–∏–∏
                            </label>
                            <div class="d-flex flex-wrap gap-2" id="reactionSelector">
                                <span class="reaction-selector" data-emoji="üëç">üëç</span>
                                <span class="reaction-selector" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</span>
                                <span class="reaction-selector" data-emoji="üî•">üî•</span>
                                <span class="reaction-selector" data-emoji="üëè">üëè</span>
                                <span class="reaction-selector" data-emoji="üòÇ">üòÇ</span>
                                <span class="reaction-selector" data-emoji="üëé">üëé</span>
                                <span class="reaction-selector" data-emoji="üòÆ">üòÆ</span>
                                <span class="reaction-selector" data-emoji="üò¢">üò¢</span>
                            </div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label">
                                    <i class="fas fa-hashtag me-2"></i>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
                                </label>
                                <input type="number" class="form-control" id="totalReactions" value="9" min="1">
                            </div>
                            <div class="col-6">
                                <label class="form-label">
                                    <i class="fas fa-clock me-2"></i>–ó–∞–¥–µ—Ä–∂–∫–∞ (—Å–µ–∫)
                                </label>
                                <input type="number" class="form-control" id="reactionDelay" value="20" min="5">
                            </div>
                        </div>

                        <button class="btn btn-warning w-100" onclick="startMultipleReactions()">
                            <i class="fas fa-rocket me-2"></i>–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–µ–∞–∫—Ü–∏–∏
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ù–∞–∫—Ä—É—Ç–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ -->
            <div class="col-12">
                <div class="card fade-in">
                    <div class="card-header">
                        <i class="fas fa-eye me-2"></i>–ù–ê–ö–†–£–¢–ö–ê –ü–†–û–°–ú–û–¢–†–û–í
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-link me-2"></i>–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç
                            </label>
                            <input type="url" class="form-control" id="viewPostUrl"
                                   placeholder="https://t.me/channel/123">
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label">
                                    <i class="fas fa-hashtag me-2"></i>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                                </label>
                                <input type="number" class="form-control" id="viewCount" value="50" min="1" max="1000">
                            </div>
                            <div class="col-6">
                                <label class="form-label">
                                    <i class="fas fa-clock me-2"></i>–ó–∞–¥–µ—Ä–∂–∫–∞ (—Å–µ–∫)
                                </label>
                                <input type="number" class="form-control" id="viewDelay" value="10" min="1">
                            </div>
                        </div>

                        <button class="btn btn-success w-100" onclick="startPostViews()">
                            <i class="fas fa-eye me-2"></i>–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä—ã
                        </button>
                    </div>
                </div>
            </div>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ -->
            <div class="col-12">
                <div class="card fade-in">
                    <div class="card-header">
                        <i class="fas fa-comment-dots me-2"></i>–£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ú–ú–ï–ù–¢–ê–†–ò–Ø–ú–ò
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button class="btn btn-info w-100" onclick="showCommentHistory()">
                                <i class="fas fa-history me-2"></i>–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                            </button>
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-danger w-100" onclick="clearAllComments()">
                                <i class="fas fa-trash-alt me-2"></i>–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ -->
    <div class="col-lg-8">
        <div class="card fade-in">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-users me-2"></i>–ê–ö–ö–ê–£–ù–¢–´ ({{ accounts|length }})
                </span>
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary me-2" id="selectedCount">0 –≤—ã–±—Ä–∞–Ω–æ</span>
                </div>
            </div>
            <div class="card-body p-3">
                <div id="alerts"></div>

                <div class="row g-3" id="accountsContainer">
                    {% for account in accounts %}
                    <div class="col-xl-4 col-lg-6 col-md-6">
                        <div class="card account-card {% if account.gender == 'male' %}border-primary{% elif account.gender == 'female' %}border-danger{% else %}border-secondary{% endif %}"
                             id="account-{{ account.id }}"
                             onclick="toggleAccountSelection({{ account.id }})">

                            <div class="card-header p-2 d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <input type="checkbox" class="form-check-input account-checkbox me-2"
                                           id="checkbox-{{ account.id }}"
                                           onclick="event.stopPropagation()">

                                    {% if account.gender == 'male' %}
                                        <i class="fas fa-mars text-primary me-2"></i>
                                    {% elif account.gender == 'female' %}
                                        <i class="fas fa-venus text-danger me-2"></i>
                                    {% else %}
                                        <i class="fas fa-question text-secondary me-2"></i>
                                    {% endif %}

                                    <small class="badge bg-{{ 'success' if account.is_active else 'danger' }}">
                                        {{ account.phone }}
                                    </small>
                                </div>

                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary btn-sm"
                                            onclick="event.stopPropagation(); editAccount({{ account.id }})"
                                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-success btn-sm"
                                            onclick="event.stopPropagation(); updateTelegramProfile({{ account.id }})"
                                            title="–û–±–Ω–æ–≤–∏—Ç—å –≤ Telegram">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="card-body p-3">
                                <div class="mb-2">
                                    <strong class="text-white">
                                        {{ account.first_name or '–ë–µ–∑ –∏–º–µ–Ω–∏' }} {{ account.last_name or '' }}
                                    </strong>
                                </div>

                                {% if account.bio %}
                                <p class="small text-muted mb-2">
                                    {{ account.bio[:40] }}{% if account.bio|length > 40 %}...{% endif %}
                                </p>
                                {% endif %}

                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-{{ 'success' if account.status == 'online' else 'secondary' }}">
                                        {{ account.status }}
                                    </span>
                                    {% if account.gender %}
                                    <span class="badge bg-{{ 'primary' if account.gender == 'male' else 'danger' }}">
                                        {{ '–ú—É–∂—Å–∫–æ–π' if account.gender == 'male' else '–ñ–µ–Ω—Å–∫–∏–π' }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="modal fade" id="editAccountModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit me-2"></i>–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ê–ö–ö–ê–£–ù–¢–ê
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editAccountForm">
                    <input type="hidden" id="editAccountId">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-user me-2"></i>–ò–º—è
                            </label>
                            <input type="text" class="form-control" id="editFirstName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-user me-2"></i>–§–∞–º–∏–ª–∏—è
                            </label>
                            <input type="text" class="form-control" id="editLastName" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é">
                        </div>
                    </div>

                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-venus-mars me-2"></i>–ì–µ–Ω–¥–µ—Ä
                            </label>
                            <select class="form-control" id="editGender">
                                <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
                                <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                                <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-image me-2"></i>–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è
                            </label>
                            <input type="file" class="form-control" id="editPhoto" accept="image/*">
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">
                            <i class="fas fa-info-circle me-2"></i>–û —Å–µ–±–µ
                        </label>
                        <textarea class="form-control" id="editBio" rows="3" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>–û—Ç–º–µ–Ω–∞
                </button>
                <button type="button" class="btn btn-primary" onclick="saveAccountChanges()">
                    <i class="fas fa-save me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
<div class="modal fade" id="commentHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-history me-2"></i>–ò–°–¢–û–†–ò–Ø –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="commentHistoryContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>–ó–∞–∫—Ä—ã—Ç—å
                </button>
                <button type="button" class="btn btn-danger" onclick="clearAccountComments()">
                    <i class="fas fa-trash-alt me-2"></i>–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.account-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border-width: 2px !important;
    background: var(--cyber-bg-card);
    overflow: hidden;
    position: relative;
}

.account-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--cyber-primary), var(--cyber-secondary), var(--cyber-accent));
    opacity: 0.7;
}

.account-card:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: var(--cyber-shadow-strong);
}

.account-card.selected {
    border-color: var(--cyber-primary) !important;
    box-shadow: var(--cyber-glow-strong) var(--cyber-primary);
    transform: translateY(-3px) scale(1.02);
}

.reaction-selector {
    cursor: pointer;
    padding: 8px 12px;
    border: 2px solid var(--cyber-border);
    border-radius: 10px;
    background: var(--cyber-bg-secondary);
    transition: all 0.3s ease;
    font-size: 18px;
    display: inline-block;
}

.reaction-selector:hover {
    border-color: var(--cyber-primary);
    box-shadow: var(--cyber-glow) var(--cyber-primary);
    transform: scale(1.1);
}

.reaction-selector.selected {
    background: var(--cyber-primary);
    border-color: var(--cyber-primary);
    box-shadow: var(--cyber-glow-strong) var(--cyber-primary);
}

.border-primary {
    border-color: var(--cyber-primary) !important;
}

.border-danger {
    border-color: var(--cyber-danger) !important;
}

.border-secondary {
    border-color: var(--cyber-border) !important;
}
</style>

<script>
let selectedAccounts = new Set();

function selectByGender(gender) {
    const cards = document.querySelectorAll('.account-card');
    cards.forEach(card => {
        const accountId = parseInt(card.id.replace('account-', ''));
        const checkbox = document.getElementById(`checkbox-${accountId}`);
        const genderIcon = card.querySelector('.fa-mars, .fa-venus');

        let shouldSelect = false;
        if (gender === 'male' && genderIcon && genderIcon.classList.contains('fa-mars')) {
            shouldSelect = true;
        } else if (gender === 'female' && genderIcon && genderIcon.classList.contains('fa-venus')) {
            shouldSelect = true;
        }

        if (shouldSelect) {
            checkbox.checked = true;
            selectedAccounts.add(accountId);
            card.classList.add('selected');
        }
    });

    updateSelectedCount();
}

function selectAll() {
    const checkboxes = document.querySelectorAll('.account-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        const accountId = parseInt(checkbox.id.replace('checkbox-', ''));
        selectedAccounts.add(accountId);
        document.getElementById(`account-${accountId}`).classList.add('selected');
    });

    updateSelectedCount();
}

function deselectAll() {
    const checkboxes = document.querySelectorAll('.account-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        const accountId = parseInt(checkbox.id.replace('checkbox-', ''));
        selectedAccounts.delete(accountId);
        document.getElementById(`account-${accountId}`).classList.remove('selected');
    });

    selectedAccounts.clear();
    updateSelectedCount();
}

function editAccount(accountId) {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞
    fetch(`/api/accounts/${accountId}`)
        .then(response => response.json())
        .then(data => {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('editAccountId').value = accountId;
            document.getElementById('editFirstName').value = data.first_name || '';
            document.getElementById('editLastName').value = data.last_name || '';
            document.getElementById('editGender').value = data.gender || '';
            document.getElementById('editBio').value = data.bio || '';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = new bootstrap.Modal(document.getElementById('editAccountModal'));
            modal.show();
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–∞:', error);
            showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–∞', 'danger');
        });
}

function showAlert(message, type = 'info') {
    const alertsContainer = document.getElementById('alerts');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertsContainer.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

function updateSelectedCount() {
    const count = selectedAccounts.size;
    const countElement = document.getElementById('selectedCount');
    if (countElement) {
        countElement.textContent = `${count} –≤—ã–±—Ä–∞–Ω–æ`;
        countElement.className = `badge ${count > 0 ? 'bg-primary' : 'bg-secondary'} me-2`;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
    const actionButtons = document.querySelectorAll('.action-btn');
    actionButtons.forEach(btn => {
        btn.disabled = count === 0;
    });

    console.log('üìä –¢–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:', Array.from(selectedAccounts));
}

function toggleAccountSelection(accountId) {
    const checkbox = document.getElementById(`checkbox-${accountId}`);
    if (!checkbox) return;

    checkbox.checked = !checkbox.checked;

    if (checkbox.checked) {
        selectedAccounts.add(parseInt(accountId));
        document.getElementById(`account-${accountId}`).classList.add('selected');
    } else {
        selectedAccounts.delete(parseInt(accountId));
        document.getElementById(`account-${accountId}`).classList.remove('selected');
    }

    updateSelectedCount();
}

async function saveAccountChanges() {
    const accountId = document.getElementById('editAccountId').value;
    const firstName = document.getElementById('editFirstName').value;
    const lastName = document.getElementById('editLastName').value;
    const gender = document.getElementById('editGender').value;
    const bio = document.getElementById('editBio').value;
    const photoFile = document.getElementById('editPhoto').files[0];

    try {
        const formData = new FormData();
        formData.append('first_name', firstName);
        formData.append('last_name', lastName);
        formData.append('gender', gender);
        formData.append('bio', bio);

        if (photoFile) {
            formData.append('photo', photoFile);
        }

        const response = await fetch(`/api/accounts/${accountId}/update`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            showAlert('–ê–∫–∫–∞—É–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = bootstrap.Modal.getInstance(document.getElementById('editAccountModal'));
            modal.hide();

            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('–û—à–∏–±–∫–∞: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'danger');
    }
}

function toggleAllAccounts() {
    const masterCheckbox = document.getElementById('selectAll');
    const accountCheckboxes = document.querySelectorAll('input[data-account-id]');

    accountCheckboxes.forEach(checkbox => {
        checkbox.checked = masterCheckbox.checked;
        const accountId = parseInt(checkbox.getAttribute('data-account-id'));

        if (masterCheckbox.checked) {
            selectedAccounts.add(accountId);
        } else {
            selectedAccounts.delete(accountId);
        }
    });

    updateSelectedCount();
}

async function updateAccountField(accountId, field, value) {
    try {
        const response = await fetch(`/api/accounts/${accountId}/update_field`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ field: field, value: value })
        });

        const result = await response.json();
        if (result.success) {
            showAlert('–ü–æ–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        } else {
            showAlert('–û—à–∏–±–∫–∞: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'danger');
    }
}

async function autoFillProfiles(gender) {
    try {
        showAlert('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π...', 'info');

        const response = await fetch('/api/accounts/auto_assign_genders', {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            showAlert(`‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ ${result.updated_count} –ø—Ä–æ—Ñ–∏–ª–µ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤–∞—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤`, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('–û—à–∏–±–∫–∞: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'danger');
    }
}

async function uploadCustomNames(input, gender, nameType) {
    const file = input.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('gender', gender);
    formData.append('name_type', nameType);

    try {
        const response = await fetch('/api/upload_custom_names', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (result.success) {
            showAlert(`–§–∞–π–ª —Å ${nameType} –¥–ª—è ${gender} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω`, 'success');
        } else {
            showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${nameType}: ${result.message}`, 'danger');
        }
    } catch (error) {
        showAlert(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ${nameType}: ${error.message}`, 'danger');
    }
}

async function uploadCustomPhotos(input, gender) {
    const files = input.files;
    if (!files || files.length === 0) return;

    const formData = new FormData();
    formData.append('gender', gender);
    for (let i = 0; i < files.length; i++) {
        formData.append('photos', files[i]);
    }

    try {
        const response = await fetch('/api/upload_custom_photos', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (result.success) {
            showAlert(`–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è ${gender} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã (${result.count} —Ñ–∞–π–ª–æ–≤)`, 'success');
        } else {
            showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π: ${result.message}`, 'danger');
        }
    } catch (error) {
        showAlert(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π: ${error.message}`, 'danger');
    }
}


async function uploadProfilePhoto(accountId) {
    const fileInput = document.getElementById(`photoUpload${accountId}`);
    const file = fileInput.files[0];

    if (!file) {
        showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', 'warning');
        return;
    }

    const formData = new FormData();
    formData.append('photo', file);

    try {
        const response = await fetch(`/api/accounts/${accountId}/upload_photo`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        if (result.success) {
            showAlert('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
        } else {
            showAlert('–û—à–∏–±–∫–∞: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'danger');
    }
}

async function updateTelegramProfile(accountId) {
    try {
        const response = await fetch(`/api/accounts/${accountId}/update_telegram_profile`, {
            method: 'POST'
        });

        const result = await response.json();
        if (result.success) {
            showAlert('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω –≤ Telegram', 'success');
        } else {
            showAlert('–û—à–∏–±–∫–∞: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'danger');
    }
}

async function updateAllTelegramProfiles() {
    if (selectedAccounts.size === 0) {
        showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã', 'warning');
        return;
    }

    try {
        const response = await fetch('/api/accounts/update_all_telegram_profiles', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                account_ids: Array.from(selectedAccounts)
            })
        });

        const result = await response.json();
        if (result.success) {
            showAlert(`–û–±–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: ${result.updated_count}`, 'success');
        } else {
            showAlert('–û—à–∏–±–∫–∞: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'danger');
    }
}

// –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–æ–≤
async function startSequentialComments() {
    console.log('üîç –û—Ç–ª–∞–¥–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤:', Array.from(selectedAccounts));

    if (selectedAccounts.size === 0) {
        showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∞–∫–∫–∞—É–Ω—Ç', 'warning');
        return;
    }

    const postUrl = document.getElementById('commentPostUrl').value;
    const maleComments = document.getElementById('maleCommentsList').value;
    const femaleComments = document.getElementById('femaleCommentsList').value;
    const delaySeconds = parseInt(document.getElementById('commentDelay').value) || 3;
    const antispamMode = document.getElementById('antispamMode').value;

    if (!postUrl) {
        showAlert('–í–≤–µ–¥–∏—Ç–µ URL –ø–æ—Å—Ç–∞', 'warning');
        return;
    }

    if (!maleComments && !femaleComments) {
        showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏', 'warning');
        return;
    }

    // –ü–∞—Ä—Å–∏–º URL –ø–æ—Å—Ç–∞
    const urlMatch = postUrl.match(/t\.me\/([^\/]+)\/(\d+)/);
    if (!urlMatch) {
        showAlert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç URL. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: https://t.me/channel/123', 'danger');
        return;
    }

    const chatId = `@${urlMatch[1]}`;
    const messageId = parseInt(urlMatch[2]);

    // –†–∞–∑–±–∏–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ –º–∞—Å—Å–∏–≤—ã
    const maleCommentsArray = maleComments.split('\n').filter(c => c.trim());
    const femaleCommentsArray = femaleComments.split('\n').filter(c => c.trim());

    console.log('üìù –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º:', Array.from(selectedAccounts)[0]);

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ü–µ–ª–∏ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç)
    const targets = [];
    const selectedAccountsArray = Array.from(selectedAccounts);

    // –ë–µ—Ä–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
    const allComments = [...maleCommentsArray, ...femaleCommentsArray];
    if (allComments.length > 0) {
        const randomComment = allComments[Math.floor(Math.random() * allComments.length)];
        targets.push({
            chat_id: chatId,
            message_id: messageId,
            comment: randomComment
        });
    }

    try {
        const response = await fetch('/api/sequential_comments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                account_id: selectedAccountsArray[0], // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
                targets: targets,
                delay_seconds: delaySeconds
            })
        });

        const result = await response.json();
        if (result.success) {
            showAlert(result.message, 'success');

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –µ—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
            const modal = document.getElementById('commentHistoryModal');
            if (modal && modal.classList.contains('show')) {
                console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                setTimeout(() => {
                    showCommentHistory();
                }, 2000); // –ó–∞–¥–µ—Ä–∂–∫–∞ 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î
            }
        } else {
            showAlert('–û—à–∏–±–∫–∞: ' + result.message, 'danger');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', error);
        showAlert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + error.message, 'danger');
    }
}


// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
let currentAccountIdForComments = null;

async function showCommentHistory() {
    if (selectedAccounts.size === 0) {
        showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤', 'warning');
        return;
    }

    const accountId = Array.from(selectedAccounts)[0];
    currentAccountIdForComments = accountId;

    const modal = new bootstrap.Modal(document.getElementById('commentHistoryModal'));
    modal.show();

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('commentHistoryContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...</p>
        </div>
    `;

    try {
        const response = await fetch(`/api/comments/history/${accountId}?_t=${Date.now()}`);
        const result = await response.json();

        console.log('–ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', result);

        if (result.success) {
            displayCommentHistory(result.comments);
        } else {
            document.getElementById('commentHistoryContent').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤'}
                </div>
            `;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
        document.getElementById('commentHistoryContent').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}
            </div>
        `;
    }
}

function displayCommentHistory(comments) {
    const content = document.getElementById('commentHistoryContent');

    if (!comments || comments.length === 0) {
        content.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                –ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø—É—Å—Ç–∞
            </div>
        `;
        return;
    }

    let html = `
        <div class="mb-3">
            <span class="badge bg-primary">–í—Å–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: ${comments.length}</span>
        </div>
        <div class="table-responsive">
            <table class="table table-dark table-striped">
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–ö–∞–Ω–∞–ª/–ß–∞—Ç</th>
                        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
    `;

    comments.forEach(comment => {
        const date = comment.sent_at ? new Date(comment.sent_at).toLocaleString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        const status = comment.status === 'sent' ?
            '<span class="badge bg-success">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</span>' :
            '<span class="badge bg-danger">–û—à–∏–±–∫–∞</span>';

        const commentText = comment.comment.length > 50 ?
            comment.comment.substring(0, 50) + '...' :
            comment.comment;

        html += `
            <tr id="comment-row-${comment.id}">
                <td>${date}</td>
                <td>${comment.chat_id}</td>
                <td title="${comment.comment}">${commentText}</td>
                <td>${status}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteComment(${comment.id})" title="–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    content.innerHTML = html;
}

async function deleteComment(commentId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')) {
        return;
    }

    try {
        const response = await fetch(`/api/comments/${commentId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            showAlert(result.message, 'success');

            // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            const row = document.getElementById(`comment-row-${commentId}`);
            if (row) {
                row.remove();
            }
        } else {
            showAlert('–û—à–∏–±–∫–∞: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message, 'danger');
    }
}

async function clearAccountComments() {
    if (!currentAccountIdForComments) {
        showAlert('–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω', 'warning');
        return;
    }

    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ —ç—Ç–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
        return;
    }

    try {
        const response = await fetch(`/api/comments/clear/${currentAccountIdForComments}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            showAlert(result.message, 'success');

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            document.getElementById('commentHistoryContent').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    –ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –æ—á–∏—â–µ–Ω–∞
                </div>
            `;
        } else {
            showAlert('–û—à–∏–±–∫–∞: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: ' + error.message, 'danger');
    }
}

async function clearAllComments() {
    if (selectedAccounts.size === 0) {
        showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤', 'warning');
        return;
    }

    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–ª—è ${selectedAccounts.size} –∞–∫–∫–∞—É–Ω—Ç–æ–≤?`)) {
        return;
    }

    let clearedCount = 0;
    const totalAccounts = selectedAccounts.size;

    for (const accountId of selectedAccounts) {
        try {
            const response = await fetch(`/api/comments/clear/${accountId}`, {
                method: 'DELETE'
            });

            const result = await response.json();
            if (result.success) {
                clearedCount++;
            }
        } catch (error) {
            console.error(`–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞ ${accountId}:`, error);
        }
    }

    showAlert(`–ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –æ—á–∏—â–µ–Ω–∞ –¥–ª—è ${clearedCount} –∏–∑ ${totalAccounts} –∞–∫–∫–∞—É–Ω—Ç–æ–≤`, 'success');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    updateSelectedCount();

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
    document.querySelectorAll('.account-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function(e) {
            e.stopPropagation();
            const accountId = parseInt(this.id.replace('checkbox-', ''));
            const card = document.getElementById(`account-${accountId}`);

            if (this.checked) {
                selectedAccounts.add(accountId);
                card.classList.add('selected');
            } else {
                selectedAccounts.delete(accountId);
                card.classList.remove('selected');
            }

            updateSelectedCount();
        });
    });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∞–∫—Ü–∏–π
document.querySelectorAll('.reaction-selector').forEach(selector => {
    selector.addEventListener('click', function() {
        this.classList.toggle('selected');
        updateReactionButtonState(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ/—Å–Ω—è—Ç–∏–∏ —Ä–µ–∞–∫—Ü–∏–∏
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–µ–∞–∫—Ü–∏–∏"
function updateReactionButtonState() {
    const selectedReactions = document.querySelectorAll('.reaction-selector.selected');
    const startButton = document.querySelector('.btn-warning[onclick="startMultipleReactions()"]');
    if (startButton) {
        startButton.disabled = selectedReactions.length === 0;
    }
}


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ä–µ–∞–∫—Ü–∏–π
async function startMultipleReactions() {
    if (selectedAccounts.size === 0) {
        showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π', 'warning');
        return;
    }

    const postUrl = document.getElementById('reactionPostUrl').value.trim();
    const totalReactions = parseInt(document.getElementById('totalReactions').value) || 1;
    const delaySeconds = parseInt(document.getElementById('reactionDelay').value) || 20;

    if (!postUrl) {
        showAlert('–í–≤–µ–¥–∏—Ç–µ URL –ø–æ—Å—Ç–∞ –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π', 'warning');
        return;
    }

    // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ –∏–∑ –∫–Ω–æ–ø–æ–∫
    const selectedReactionButtons = document.querySelectorAll('.reaction-selector.selected');
    const selectedReactions = Array.from(selectedReactionButtons).map(btn => btn.dataset.emoji);

    if (selectedReactions.length === 0) {
        showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ä–µ–∞–∫—Ü–∏—é', 'warning');
        return;
    }

    console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏–∏:', {
        post_url: postUrl,
        reactions: selectedReactions,
        total_count: totalReactions,
        selected_accounts: Array.from(selectedAccounts),
        delay_seconds: delaySeconds
    });

    try {
        const response = await fetch('/api/multiple_reactions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                post_url: postUrl,
                reactions: selectedReactions,
                total_count: totalReactions,
                selected_accounts: Array.from(selectedAccounts),
                delay_seconds: delaySeconds
            })
        });

        const result = await response.json();

        if (result.success) {
            showAlert(`–†–µ–∞–∫—Ü–∏–∏ –∑–∞–ø—É—â–µ–Ω—ã! –ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${totalReactions} —Ä–µ–∞–∫—Ü–∏–π —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π ${delaySeconds} —Å–µ–∫—É–Ω–¥`, 'success');
        } else {
            showAlert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–µ–∞–∫—Ü–∏–π: ' + result.message, 'danger');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–µ–∞–∫—Ü–∏–π:', error);
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'danger');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–∞–∫—Ä—É—Ç–∫–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
async function startPostViews() {
    if (selectedAccounts.size === 0) {
        showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã –¥–ª—è –Ω–∞–∫—Ä—É—Ç–∫–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤', 'warning');
        return;
    }

    const postUrl = document.getElementById('viewPostUrl').value.trim();
    const viewCount = parseInt(document.getElementById('viewCount').value) || 10;
    const delaySeconds = parseInt(document.getElementById('viewDelay').value) || 10;

    if (!postUrl) {
        showAlert('–í–≤–µ–¥–∏—Ç–µ URL –ø–æ—Å—Ç–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤', 'warning');
        return;
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è URL
    const urlPattern = /t\.me\/([^\/]+)\/(\d+)/;
    const urlMatch = postUrl.match(urlPattern);
    if (!urlMatch) {
        showAlert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç URL. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: https://t.me/channel/123', 'danger');
        return;
    }

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
    const accountsToUse = Math.min(selectedAccounts.size, viewCount);

    console.log('–ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä—ã:', {
        post_url: postUrl,
        view_count: viewCount,
        selected_accounts: Array.from(selectedAccounts),
        delay_seconds: delaySeconds,
        accounts_to_use: accountsToUse
    });

    try {
        const response = await fetch('/api/post_views', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                post_url: postUrl,
                view_count: viewCount,
                selected_accounts: Array.from(selectedAccounts),
                delay_seconds: delaySeconds
            })
        });

        const result = await response.json();

        if (result.success) {
            showAlert(`–ù–∞–∫—Ä—É—Ç–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∑–∞–ø—É—â–µ–Ω–∞! –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ${accountsToUse} –∞–∫–∫–∞—É–Ω—Ç–æ–≤ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π ${delaySeconds} —Å–µ–∫—É–Ω–¥`, 'success');
        } else {
            showAlert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: ' + result.message, 'danger');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤:', error);
        showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'danger');
    }
}
</script>
{% endblock %}