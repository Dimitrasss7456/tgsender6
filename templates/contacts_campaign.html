{% extends "base.html" %}

{% block title %}–†–∞—Å—Å—ã–ª–∫–∞ –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º - Telegram Mass Sender{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">–†–∞—Å—Å—ã–ª–∫–∞ –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º</h1>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-address-book"></i> –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º</h5>
            </div>
            <div class="card-body">
                <form id="contactsCampaignForm" onsubmit="startContactsCampaign(event)">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-users"></i> –í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
                        </label>
                        <div id="accountsContainer" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤...
                            </div>
                        </div>
                        <div class="mt-2 d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllAccounts()">
                                <i class="fas fa-check-double"></i> –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllAccounts()">
                                <i class="fas fa-times"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä
                            </button>
                            <span class="badge bg-info ms-auto align-self-center" id="selectedCount">–í—ã–±—Ä–∞–Ω–æ: 0</span>
                        </div>
                        <div id="selectedAccountsDebug" class="mt-2 small text-muted" style="display: none;"></div>
                    </div>

                    <div class="mb-3">
                        <label for="message" class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏</label>
                        <textarea class="form-control" id="message" rows="4" required
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Å–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–∞–º"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="fileUpload" class="form-label">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="file" class="form-control" id="fileUpload" accept="*/*">
                        <div class="form-text">
                            –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ª—é–±—ã–µ —Ñ–∞–π–ª—ã –≤–∫–ª—é—á–∞—è APK. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50 –ú–ë
                        </div>
                        <div id="fileInfo" class="mt-2 text-muted" style="display: none;"></div>
                    </div>

                    <div class="mb-3">
                        <label for="delaySeconds" class="form-label">–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (—Å–µ–∫)</label>
                        <input type="number" class="form-control" id="delaySeconds" value="0" min="0" max="3600">
                        <div class="form-text">–ó–∞–¥–µ—Ä–∂–∫–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö. 0 = –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ –≤—Å–µ—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ</div>
                    </div>

                    <div class="mb-3">
                        <label for="startInMinutes" class="form-label">–û—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ (–º–∏–Ω—É—Ç—ã)</label>
                        <input type="number" class="form-control" id="startInMinutes" min="1" max="1440" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞">
                        <div class="form-text">–£–∫–∞–∂–∏—Ç–µ —á–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É (–º–∞–∫—Å–∏–º—É–º 24 —á–∞—Å–∞)</div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoDeleteAccount">
                            <label class="form-check-label text-danger" for="autoDeleteAccount">
                                <strong>üóëÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –∏–∑ Telegram –ø–æ—Å–ª–µ —Ä–∞—Å—Å—ã–ª–∫–∏</strong>
                            </label>
                            <div class="form-text text-warning">
                                <small>‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ê–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω –∏–∑ Telegram —á–µ—Ä–µ–∑ 5-7 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</small>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-paper-plane"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
                        </button>
                    </div>
                </form>

                <div id="result" class="mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-lightbulb"></i> –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</h6>
                    <ul class="mb-0">
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏</li>
                        <li>–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</li>
                        <li>–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª</li>
                        <li>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏</li>
                        <li>–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã —Å–æ –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</li>
                        <li>–î—É–±–ª–∏—Ä—É—é—â–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –±—É–¥—É—Ç –∏—Å–∫–ª—é—á–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                        <li>–†–∞—Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ –≤—Å–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∫–æ–Ω—Ç–∞–∫—Ç–∞–º</li>
                        <li>–ù–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –º–µ–∂–¥—É –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏</li>
                    </ul>
                </div>

                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle"></i> –í–∞–∂–Ω–æ:</h6>
                    <ul class="mb-0">
                        <li>APK —Ñ–∞–π–ª—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</li>
                        <li>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –≤–∏–¥–µ–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                        <li>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 50 –ú–ë</li>
                        <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑—É–º–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫</li>
                        <li>–ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–ø–∞–º - —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∞–∫–∫–∞—É–Ω—Ç–∞</li>
                    </ul>
                </div>

                <div id="campaignStatus" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
let selectedAccounts = new Set();
let allAccounts = [];
let uploadedFilePath = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–∞—Å—Å—ã–ª–∫–∏ –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º...');

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadAccounts();

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
    setupFileUpload();

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–º–ø–∞–Ω–∏–π
    setInterval(updateCampaignStatus, 5000);
    updateCampaignStatus();
});

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
async function loadAccounts() {
    try {
        console.log('üì± –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–æ–≤...');

        const response = await fetch('/api/accounts');
        const accounts = await response.json();

        console.log(`üìä –ü–æ–ª—É—á–µ–Ω–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤: ${accounts.length}`);

        allAccounts = accounts;
        renderAccounts(accounts);

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤:', error);
        showAccountsError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤');
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
function renderAccounts(accounts) {
    const container = document.getElementById('accountsContainer');

    if (!accounts || accounts.length === 0) {
        container.innerHTML = '<div class="text-center text-warning">‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>';
        return;
    }

    const activeAccounts = accounts.filter(account => account.is_active && account.status === 'online');
    const inactiveAccounts = accounts.filter(account => !account.is_active || account.status !== 'online');

    console.log(`‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤: ${activeAccounts.length}, –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö: ${inactiveAccounts.length}`);

    let html = '';

    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã
    if (activeAccounts.length > 0) {
        html += '<div class="mb-3"><strong class="text-success">–ê–∫—Ç–∏–≤–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:</strong></div>';

        activeAccounts.forEach(account => {
            const displayName = account.name || account.phone;
            html += `
                <div class="form-check mb-2">
                    <input class="form-check-input account-checkbox" 
                           type="checkbox" 
                           value="${account.id}" 
                           id="account_${account.id}" 
                           onchange="toggleAccount(${account.id}, this.checked)">
                    <label class="form-check-label text-success" for="account_${account.id}">
                        <i class="fas fa-check-circle me-1"></i>
                        <strong>${displayName}</strong> (${account.phone})
                    </label>
                </div>
            `;
        });
    }

    // –ó–∞—Ç–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã
    if (inactiveAccounts.length > 0) {
        html += '<div class="mb-2 mt-3"><strong class="text-muted">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:</strong></div>';

        inactiveAccounts.forEach(account => {
            const displayName = account.name || account.phone;
            html += `
                <div class="form-check mb-2">
                    <input class="form-check-input account-checkbox" 
                           type="checkbox" 
                           value="${account.id}" 
                           id="account_${account.id}" 
                           disabled>
                    <label class="form-check-label text-muted" for="account_${account.id}">
                        <i class="fas fa-times-circle me-1"></i>
                        ${displayName} (${account.phone}) - ${account.status}
                    </label>
                </div>
            `;
        });
    }

    if (activeAccounts.length === 0) {
        html += '<div class="text-center text-danger mt-3">‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏</div>';
    }

    container.innerHTML = html;
    updateSelectedCount();
}

// –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
function showAccountsError(message) {
    const container = document.getElementById('accountsContainer');
    container.innerHTML = `<div class="text-center text-danger">‚ùå ${message}</div>`;
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
function toggleAccount(accountId, isChecked) {
    console.log(`üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ ${accountId}: ${isChecked}`);

    if (isChecked) {
        selectedAccounts.add(accountId);
    } else {
        selectedAccounts.delete(accountId);
    }

    updateSelectedCount();
    updateDebugInfo();
}

// –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã
function selectAllAccounts() {
    console.log('‚úÖ –í—ã–±–∏—Ä–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã');

    const checkboxes = document.querySelectorAll('.account-checkbox:not(:disabled)');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        selectedAccounts.add(parseInt(checkbox.value));
    });

    updateSelectedCount();
    updateDebugInfo();
}

// –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä –≤—Å–µ—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
function clearAllAccounts() {
    console.log('üóëÔ∏è –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä –≤—Å–µ—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤');

    const checkboxes = document.querySelectorAll('.account-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });

    selectedAccounts.clear();
    updateSelectedCount();
    updateDebugInfo();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
function updateSelectedCount() {
    const count = selectedAccounts.size;
    document.getElementById('selectedCount').textContent = `–í—ã–±—Ä–∞–Ω–æ: ${count}`;

    // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    const badge = document.getElementById('selectedCount');
    if (count === 0) {
        badge.className = 'badge bg-secondary ms-auto align-self-center';
    } else if (count <= 3) {
        badge.className = 'badge bg-info ms-auto align-self-center';
    } else {
        badge.className = 'badge bg-success ms-auto align-self-center';
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
function updateDebugInfo() {
    const debugDiv = document.getElementById('selectedAccountsDebug');
    const selectedArray = Array.from(selectedAccounts);

    if (selectedArray.length > 0) {
        debugDiv.innerHTML = `–í—ã–±—Ä–∞–Ω–Ω—ã–µ ID: [${selectedArray.join(', ')}]`;
        debugDiv.style.display = 'block';
    } else {
        debugDiv.style.display = 'none';
    }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
function setupFileUpload() {
    const fileUpload = document.getElementById('fileUpload');
    const fileInfo = document.getElementById('fileInfo');

    fileUpload.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) {
            fileInfo.style.display = 'none';
            uploadedFilePath = null;
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
        if (file.size > 50 * 1024 * 1024) {
            showResult('error', '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50 –ú–ë');
            fileUpload.value = '';
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
        const fileSize = (file.size / (1024 * 1024)).toFixed(2);
        fileInfo.innerHTML = `
            <i class="fas fa-file"></i> ${file.name} (${fileSize} –ú–ë)
            <span class="text-primary">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        `;
        fileInfo.style.display = 'block';

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        try {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/api/upload-file', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.status === 'success') {
                uploadedFilePath = result.path;
                fileInfo.innerHTML = `
                    <i class="fas fa-check-circle text-success"></i>
                    ${file.name} (${fileSize} –ú–ë) - –ó–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ
                `;
            } else {
                throw new Error(result.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
            }
        } catch (error) {
            showResult('error', `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ${error.message}`);
            fileUpload.value = '';
            fileInfo.style.display = 'none';
            uploadedFilePath = null;
        }
    });
}

// –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–ø–∞–Ω–∏–∏
async function startContactsCampaign(event) {
    event.preventDefault();

    console.log('üöÄ –ó–∞–ø—É—Å–∫ –∫–∞–º–ø–∞–Ω–∏–∏ –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º...');

    // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã
    const selectedAccountsArray = Array.from(selectedAccounts);

    console.log('üìä –í—ã–±—Ä–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:', selectedAccountsArray);
    console.log('üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö:', selectedAccountsArray.length);

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    if (selectedAccountsArray.length === 0) {
        showResult('error', '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏');
        return;
    }

    const message = document.getElementById('message').value.trim();
    if (!message) {
        showResult('error', '‚ùå –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏');
        return;
    }

    // –ü–æ–ª—É—á–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
    const delaySeconds = parseInt(document.getElementById('delaySeconds').value) || 0;
    const startInMinutes = parseInt(document.getElementById('startInMinutes').value) || null;
    const autoDeleteAccount = document.getElementById('autoDeleteAccount').checked;

    console.log('üìù –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–º–ø–∞–Ω–∏–∏:');
    console.log(`   –°–æ–æ–±—â–µ–Ω–∏–µ: "${message.substring(0, 50)}..."`);
    console.log(`   –ó–∞–¥–µ—Ä–∂–∫–∞: ${delaySeconds} —Å–µ–∫`);
    console.log(`   –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ: ${autoDeleteAccount}`);
    console.log(`   –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫: ${startInMinutes || '–Ω–µ—Ç'} –º–∏–Ω`);

    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const formData = new FormData();
    formData.append('message', message);
    formData.append('delay_seconds', delaySeconds.toString());
    formData.append('auto_delete_account', autoDeleteAccount.toString());
    formData.append('delete_delay_minutes', '5');

    // –ü—Ä–æ—Å—Ç–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
    formData.append('selected_accounts', selectedAccountsArray.join(','));

    if (startInMinutes) {
        formData.append('start_in_minutes', startInMinutes.toString());
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω
    const fileInput = document.getElementById('fileUpload');
    if (fileInput.files.length > 0) {
        formData.append('attachment', fileInput.files[0]);
        console.log('üìé –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∞–π–ª:', fileInput.files[0].name);
    }

    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>–ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å—Å—ã–ª–∫—É...';

    try {
        showResult('info', 'üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å—Å—ã–ª–∫—É –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º...');

        console.log('üì° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');

        const response = await fetch('/api/start-contacts-campaign', {
            method: 'POST',
            body: formData
        });

        console.log('üì° –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, —Å—Ç–∞—Ç—É—Å:', response.status);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const result = await response.json();
        console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞:', result);

        if (result.status === 'success') {
            const successMessage = `‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!
                                 üì± –ê–∫–∫–∞—É–Ω—Ç–æ–≤ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–æ: ${result.accounts_used || selectedAccountsArray.length}
                                 üéØ –ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏: ${result.contacts_count || '–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...'}
                                 ${result.message || ''}`;

            showResult('success', successMessage);

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
            resetForm();

        } else {
            showResult('error', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ${result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
        }

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
        showResult('error', `‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ${error.message}`);
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
function resetForm() {
    console.log('üîÑ –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É...');

    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
    document.getElementById('message').value = '';
    document.getElementById('delaySeconds').value = '0';
    document.getElementById('startInMinutes').value = '';
    document.getElementById('autoDeleteAccount').checked = false;
    document.getElementById('fileUpload').value = '';

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∞–∫–∫–∞—É–Ω—Ç–æ–≤
    clearAllAccounts();

    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
    document.getElementById('fileInfo').style.display = 'none';
    uploadedFilePath = null;

    console.log('‚úÖ –§–æ—Ä–º–∞ —Å–±—Ä–æ—à–µ–Ω–∞');
}

// –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π
function showResult(type, message) {
    const resultDiv = document.getElementById('result');

    let alertClass = 'alert-info';
    let icon = 'info-circle';

    if (type === 'success') {
        alertClass = 'alert-success';
        icon = 'check-circle';
    } else if (type === 'error') {
        alertClass = 'alert-danger';
        icon = 'exclamation-circle';
    } else if (type === 'warning') {
        alertClass = 'alert-warning';
        icon = 'exclamation-triangle';
    }

    resultDiv.className = `alert ${alertClass}`;
    resultDiv.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
    resultDiv.style.display = 'block';

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
    if (type === 'info') {
        setTimeout(() => {
            resultDiv.style.display = 'none';
        }, 10000);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–º–ø–∞–Ω–∏–π
async function updateCampaignStatus() {
    try {
        const response = await fetch('/api/scheduled-campaigns');
        const data = await response.json();

        const statusDiv = document.getElementById('campaignStatus');
        if (data.scheduled_campaigns && data.scheduled_campaigns.length > 0) {
            statusDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-clock"></i>
                    –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π: ${data.scheduled_campaigns.length}
                </div>
            `;
        } else {
            statusDiv.innerHTML = '';
        }
    } catch (error) {
        console.error('Error updating campaign status:', error);
    }
}
</script>
{% endblock %}