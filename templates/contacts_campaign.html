{% extends "base.html" %}

{% block title %}–†–∞—Å—Å—ã–ª–∫–∞ –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º - Telegram Mass Sender{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">–†–∞—Å—Å—ã–ª–∫–∞ –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º</h1>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-address-book"></i> –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º</h5>
            </div>
            <div class="card-body">
                <form id="contactsCampaignForm">
                    <div class="mb-3">
                        <label for="accountSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏</label>
                        <select class="form-select" id="accountSelect" multiple size="6" required>
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤...</option>
                        </select>
                        <div class="form-text">
                            –£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl (Cmd –Ω–∞ Mac) –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤.
                            –ö–æ–Ω—Ç–∞–∫—Ç—ã –±—É–¥—É—Ç —Å–æ–±—Ä–∞–Ω—ã —Å–æ –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤, –¥—É–±–ª–∏–∫–∞—Ç—ã –∏—Å–∫–ª—é—á–µ–Ω—ã.
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllAccounts">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAllAccounts">–û—á–∏—Å—Ç–∏—Ç—å</button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="message" class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏</label>
                        <textarea class="form-control" id="message" rows="4" required
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Å–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–∞–º"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="fileUpload" class="form-label">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="file" class="form-control" id="fileUpload" accept="*/*">
                        <div class="form-text">
                            –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ª—é–±—ã–µ —Ñ–∞–π–ª—ã –≤–∫–ª—é—á–∞—è APK. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50 –ú–ë
                        </div>
                        <div id="fileInfo" class="mt-2 text-muted" style="display: none;"></div>
                    </div>

                    <div class="mb-3">
                        <label for="delaySeconds" class="form-label">–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (—Å–µ–∫—É–Ω–¥—ã)</label>
                        <input type="number" class="form-control" id="delaySeconds" name="delaySeconds" value="5" min="1" max="300">
                        <small class="form-text text-muted">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 5-7 —Å–µ–∫—É–Ω–¥</small>
                    </div>

                    <div class="mb-3">
                        <label for="startInMinutes" class="form-label">–û—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ (–º–∏–Ω—É—Ç—ã)</label>
                        <input type="number" class="form-control" id="startInMinutes" name="start_in_minutes" min="1" max="1440" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞">
                        <div class="form-text">–£–∫–∞–∂–∏—Ç–µ —á–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É (–º–∞–∫—Å–∏–º—É–º 24 —á–∞—Å–∞)</div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoDeleteAccount">
                            <label class="form-check-label text-danger" for="autoDeleteAccount">
                                <strong>üóëÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –∏–∑ Telegram –ø–æ—Å–ª–µ —Ä–∞—Å—Å—ã–ª–∫–∏</strong>
                            </label>
                            <div class="form-text text-warning">
                                <small>‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ê–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω –∏–∑ Telegram —á–µ—Ä–µ–∑ 5-7 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</small>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" id="submitBtn" onclick="startContactsCampaign()">
                            <i class="fas fa-paper-plane"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
                        </button>
                    </div>
                </form>

                <div id="result" class="mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-lightbulb"></i> –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</h6>
                    <ul class="mb-0">
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏</li>
                        <li>–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</li>
                        <li>–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª</li>
                        <li>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏</li>
                        <li>–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã —Å–æ –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</li>
                        <li>–î—É–±–ª–∏—Ä—É—é—â–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –±—É–¥—É—Ç –∏—Å–∫–ª—é—á–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                        <li>–†–∞—Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ –≤—Å–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∫–æ–Ω—Ç–∞–∫—Ç–∞–º</li>
                        <li>–ù–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –º–µ–∂–¥—É –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏</li>
                    </ul>
                </div>

                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle"></i> –í–∞–∂–Ω–æ:</h6>
                    <ul class="mb-0">
                        <li>APK —Ñ–∞–π–ª—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</li>
                        <li>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –≤–∏–¥–µ–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                        <li>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 50 –ú–ë</li>
                        <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑—É–º–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫</li>
                        <li>–ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–ø–∞–º - —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∞–∫–∫–∞—É–Ω—Ç–∞</li>
                    </ul>
                </div>

                <div id="campaignStatus" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const accountSelect = document.getElementById('accountSelect');
    const form = document.getElementById('contactsCampaignForm');
    const resultDiv = document.getElementById('result');
    const submitBtn = document.getElementById('submitBtn');
    const fileUpload = document.getElementById('fileUpload');
    const fileInfo = document.getElementById('fileInfo');
    let uploadedFilePath = null;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
    loadAccounts();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
    fileUpload.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) {
            fileInfo.style.display = 'none';
            uploadedFilePath = null;
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
        if (file.size > 50 * 1024 * 1024) {
            showResult('error', '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50 –ú–ë');
            fileUpload.value = '';
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
        const fileSize = (file.size / (1024 * 1024)).toFixed(2);
        fileInfo.innerHTML = `
            <i class="fas fa-file"></i> ${file.name} (${fileSize} –ú–ë)
            <span class="text-primary">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        `;
        fileInfo.style.display = 'block';

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        try {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/api/upload-file', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.status === 'success') {
                uploadedFilePath = result.path;
                fileInfo.innerHTML = `
                    <i class="fas fa-check-circle text-success"></i>
                    ${file.name} (${fileSize} –ú–ë) - –ó–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ
                `;
            } else {
                throw new Error(result.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
            }
        } catch (error) {
            showResult('error', `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ${error.message}`);
            fileUpload.value = '';
            fileInfo.style.display = 'none';
            uploadedFilePath = null;
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
    document.getElementById('selectAllAccounts').addEventListener('click', function() {
        const options = accountSelect.querySelectorAll('option');
        options.forEach(option => {
            if (option.value !== '') {
                option.selected = true;
            }
        });
    });

    document.getElementById('clearAllAccounts').addEventListener('click', function() {
        const options = accountSelect.querySelectorAll('option');
        options.forEach(option => {
            option.selected = false;
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã (–¥–ª—è –æ–±—ã—á–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏, –Ω–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞)
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const selectedOptions = Array.from(accountSelect.selectedOptions);
        const accountIds = selectedOptions.map(option => option.value).filter(value => value !== '');
        const message = document.getElementById('message').value;
        const delaySeconds = parseInt(document.getElementById('delaySeconds').value);
        const startInMinutes = document.getElementById('startInMinutes').value;
        const autoDeleteAccount = document.getElementById('autoDeleteAccount').checked;
        // Ensure deleteDelay is correctly accessed; assuming it might be a number input with id 'deleteDelay'
        // If it's not present or handled elsewhere, this might need adjustment.
        // For now, assuming it's handled by the startContactsCampaign function logic.

        if (accountIds.length === 0) {
            showResult('error', '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∞–∫–∫–∞—É–Ω—Ç');
            return;
        }

        if (!message.trim()) {
            showResult('error', '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–ø—É—Å–∫...';

        try {
            const formData = new FormData();
            formData.append('account_ids', JSON.stringify(accountIds));
            formData.append('message', message);
            formData.append('delay_seconds', delaySeconds);
            formData.append('auto_delete_account', autoDeleteAccount);
            // If deleteDelay is a field, it should be appended here.
            // formData.append('delete_delay_minutes', deleteDelay);
            if (startInMinutes) {
                formData.append('start_in_minutes', startInMinutes);
            }
            if (uploadedFilePath) {
                formData.append('attachment_path', uploadedFilePath);
            }

            const response = await fetch('/api/contacts-campaign/start', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.status === 'success') {
                showResult('success', result.message);
                form.reset();
                uploadedFilePath = null;
                fileInfo.style.display = 'none';
                // –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä –∞–∫–∫–∞—É–Ω—Ç–æ–≤
                accountSelect.querySelectorAll('option').forEach(option => option.selected = false);
            } else {
                showResult('error', result.message);
            }
        } catch (error) {
            showResult('error', '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–∏: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É';
        }
    });

    async function loadAccounts() {
        try {
            const response = await fetch('/api/accounts');
            const accounts = await response.json();

            accountSelect.innerHTML = ''; // Clear previous options

            if (accounts.length === 0) {
                 accountSelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</option>';
                 return;
            }

            accounts.forEach(account => {
                if (account.is_active && account.status === 'online') {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = `${account.name} (${account.phone})`;
                    accountSelect.appendChild(option);
                }
            });

            if (accountSelect.children.length === 0) {
                accountSelect.innerHTML = '<option value="">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–Ω–ª–∞–π–Ω –∞–∫–∫–∞—É–Ω—Ç–æ–≤</option>';
            }
        } catch (error) {
            console.error('Error loading accounts:', error);
            accountSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤</option>';
        }
    }

    function showResult(type, message) {
        resultDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
        resultDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
        resultDiv.style.display = 'block';
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–º–ø–∞–Ω–∏–π –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    setInterval(updateCampaignStatus, 5000);
    updateCampaignStatus();

    async function updateCampaignStatus() {
        try {
            const response = await fetch('/api/scheduled-campaigns');
            const data = await response.json();

            const statusDiv = document.getElementById('campaignStatus');
            if (data.scheduled_campaigns && data.scheduled_campaigns.length > 0) {
                statusDiv.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-clock"></i>
                        –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π: ${data.scheduled_campaigns.length}
                    </div>
                `;
            } else {
                statusDiv.innerHTML = '';
            }
        } catch (error) {
            console.error('Error updating campaign status:', error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º
    async function startContactsCampaign() {
        const form = document.getElementById('contactsCampaignForm');
        const formData = new FormData(form);

        // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –∏–∑ select
        const accountSelectElement = document.getElementById('accountSelect');
        const selectedAccounts = Array.from(accountSelectElement.selectedOptions).map(option => option.value).filter(value => value !== '');

        if (selectedAccounts.length === 0) {
            showResult('warning', '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏');
            return;
        }

        const message = document.getElementById('message').value;
        if (!message || message.trim() === '') {
            showResult('warning', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
            return;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –≤ formData
        formData.set('account_ids', JSON.stringify(selectedAccounts));
        formData.append('attachment_path', uploadedFilePath || ''); // Ensure attachment_path is set

        const startBtn = document.getElementById('submitBtn'); // Using submitBtn as it's the actual button
        const originalText = startBtn.innerHTML;

        try {
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>–ó–∞–ø—É—Å–∫–∞–µ–º...';

            const response = await fetch('/api/contacts-campaign/start', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.status === 'success') {
                showResult('success', `–†–∞—Å—Å—ã–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞! –ê–∫–∫–∞—É–Ω—Ç–æ–≤: ${selectedAccounts.length}, –ö–æ–Ω—Ç–∞–∫—Ç–æ–≤: ${result.contacts_count || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
                form.reset();
                uploadedFilePath = null;
                fileInfo.style.display = 'none';
                // –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä –∞–∫–∫–∞—É–Ω—Ç–æ–≤
                accountSelectElement.querySelectorAll('option').forEach(option => option.selected = false);
            } else {
                showResult('error', result.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏');
            }

        } catch (error) {
            console.error('Error starting campaign:', error);
            showResult('error', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        } finally {
            startBtn.disabled = false;
            startBtn.innerHTML = originalText;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ)
    function showAlert(message, type = 'info') {
        const alertContainer = document.getElementById('alertContainer') || createAlertContainer();

        const alertElement = document.createElement('div');
        alertElement.className = `alert alert-${type} alert-dismissible fade show`;
        alertElement.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        alertContainer.appendChild(alertElement);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            if (alertElement.parentNode) {
                alertElement.remove();
            }
        }, 5000);
    }

    function createAlertContainer() {
        const container = document.createElement('div');
        container.id = 'alertContainer';
        container.style.position = 'fixed';
        container.style.top = '20px';
        container.style.right = '20px';
        container.style.zIndex = '9999';
        container.style.width = '400px';
        document.body.appendChild(container);
        return container;
    }

    // Helper to load accounts for campaign form (if different from initial load)
    // In this case, it seems to be the same as loadAccounts, so could be merged or kept for clarity.
    function loadAccountsForCampaign() {
        loadAccounts();
    }
});
</script>
{% endblock %}