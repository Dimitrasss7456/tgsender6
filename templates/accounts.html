{% extends "base.html" %}

{% block title %}Аккаунты - Telegram Mass Sender{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Управление аккаунтами</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
        <i class="fas fa-plus"></i> Добавить аккаунт
    </button>
</div>

<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Телефон</th>
                <th>Имя</th>
                <th>Статус</th>
                <th>Прокси</th>
                <th>Сообщений сегодня</th>
                <th>Последняя активность</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for account in accounts %}
            <tr>
                <td>{{ account.id }}</td>
                <td>{{ account.phone }}</td>
                <td>{{ account.name or '-' }}</td>
                <td>
                    <span class="badge bg-{% if account.status == 'online' %}success{% elif account.status == 'offline' %}secondary{% elif account.status == 'error' %}danger{% else %}warning{% endif %}">
                        {{ account.status }}
                    </span>
                </td>
                <td>{{ account.proxy or '-' }}</td>
                <td>{{ account.messages_sent_today }}</td>
                <td>{{ account.last_activity.strftime('%d.%m.%Y %H:%M') if account.last_activity else '-' }}</td>
                <td>
                    <button class="btn btn-sm btn-{% if account.is_active %}warning{% else %}success{% endif %}"
                            onclick="toggleAccount({{ account.id }})">
                        {% if account.is_active %}Отключить{% else %}Включить{% endif %}
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteAccount({{ account.id }})">
                        Удалить
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Модальное окно добавления аккаунта -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить аккаунт</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Добавить аккаунт</h5>
                                <div class="btn-group btn-group-sm" role="group">
                                    <input type="radio" class="btn-check" name="addMethod" id="methodPhone" checked>
                                    <label class="btn btn-outline-primary" for="methodPhone">По номеру</label>

                                    <input type="radio" class="btn-check" name="addMethod" id="methodTdata">
                                    <label class="btn btn-outline-primary" for="methodTdata">TDATA</label>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Форма добавления по номеру телефона -->
                                <div id="phoneForm" class="add-method-form">
                                    <form id="addAccountForm">
                                        <div class="mb-3">
                                            <label for="phone" class="form-label">Номер телефона</label>
                                            <input type="text" class="form-control" id="phone" placeholder="+1234567890" required>
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="useAutoProxy">
                                                <label class="form-check-label" for="useAutoProxy">
                                                    Использовать автоматический прокси
                                                </label>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Добавить аккаунт</button>
                                    </form>
                                </div>

                                <!-- Форма загрузки TDATA -->
                                <div id="tdataForm" class="add-method-form" style="display: none;">
                                    <form id="addTdataForm" enctype="multipart/form-data">
                                        <div class="mb-3">
                                            <label for="tdataFiles" class="form-label">Файлы TDATA</label>
                                            <input type="file" class="form-control" id="tdataFiles" multiple accept="*" required>
                                            <div class="form-text">
                                                Выберите все файлы из папки TDATA (обычно находится в %APPDATA%\Telegram Desktop\tdata)
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="useAutoProxyTdata">
                                                <label class="form-check-label" for="useAutoProxyTdata">
                                                    Использовать автоматический прокси
                                                </label>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-success">Импортировать TDATA</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <!-- Кнопка добавления будет внутри форм -->
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения кода -->
<div class="modal fade" id="codeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Введите код подтверждения</h5>
            </div>
            <div class="modal-body">
                <form id="codeForm">
                    <input type="hidden" name="phone">
                    <input type="hidden" name="phone_code_hash">
                    <input type="hidden" name="session_name">
                    <input type="hidden" name="proxy">
                    <div class="mb-3">
                        <label class="form-label">Код из Telegram</label>
                        <input type="text" class="form-control" name="code" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="verifyCode()">Подтвердить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно ввода пароля 2FA -->
<div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Двухфакторная аутентификация</h5>
            </div>
            <div class="modal-body">
                <form id="passwordForm">
                    <input type="hidden" name="phone">
                    <input type="hidden" name="session_name">
                    <input type="hidden" name="proxy">
                    <div class="mb-3">
                        <label class="form-label">Пароль 2FA</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="verifyPassword()">Подтвердить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function addAccount() {
    const form = document.getElementById('addAccountForm');
    const formData = new FormData(form);

    // Если чекбокс "Использовать автоматический прокси" не отмечен, удаляем его из formData
    if (!formData.get('use_auto_proxy')) {
        formData.delete('use_auto_proxy');
    }


    fetch('/accounts/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'code_required') {
            // Заполняем скрытые поля для подтверждения кода
            const codeForm = document.getElementById('codeForm');
            codeForm.phone.value = formData.get('phone');
            codeForm.phone_code_hash.value = data.phone_code_hash;
            codeForm.session_name.value = data.session_name;
            // Передаем значение use_auto_proxy, если оно есть
            codeForm.proxy.value = formData.get('use_auto_proxy') ? 'auto' : formData.get('proxy') || '';


            // Показываем модальное окно ввода кода
            new bootstrap.Modal(document.getElementById('codeModal')).show();
            bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
        } else if (data.status === 'success') {
            alert('Аккаунт успешно добавлен!');
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        alert('Ошибка: ' + error);
    });
}

function verifyCode() {
    const form = document.getElementById('codeForm');
    const formData = new FormData(form);

    fetch('/accounts/verify_code', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'password_required') {
            // Заполняем скрытые поля для ввода пароля
            const passwordForm = document.getElementById('passwordForm');
            passwordForm.phone.value = formData.get('phone');
            passwordForm.session_name.value = data.session_name;
            passwordForm.proxy.value = formData.get('proxy') || ''; // Сохраняем proxy, если оно было указано вручную

            // Показываем модальное окно ввода пароля
            new bootstrap.Modal(document.getElementById('passwordModal')).show();
            bootstrap.Modal.getInstance(document.getElementById('codeModal')).hide();
        } else if (data.status === 'success') {
            alert('Аккаунт успешно добавлен!');
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        alert('Ошибка: ' + error);
    });
}

function verifyPassword() {
    const form = document.getElementById('passwordForm');
    const formData = new FormData(form);

    fetch('/accounts/verify_password', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Аккаунт успешно добавлен!');
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        alert('Ошибка: ' + error);
    });
}

function toggleAccount(accountId) {
    fetch(`/accounts/${accountId}/toggle`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    });
}

function deleteAccount(accountId) {
    if (confirm('Вы уверены, что хотите удалить этот аккаунт?')) {
        fetch(`/accounts/${accountId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Ошибка: ' + data.message);
            }
        });
    }
}

// Переключение между методами добавления
        document.querySelectorAll('input[name="addMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.add-method-form').forEach(form => {
                    form.style.display = 'none';
                });

                if (this.id === 'methodPhone') {
                    document.getElementById('phoneForm').style.display = 'block';
                } else if (this.id === 'methodTdata') {
                    document.getElementById('tdataForm').style.display = 'block';
                }
            });
        });

        // Обработчик формы добавления аккаунта по номеру
        document.getElementById('addAccountForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const phone = document.getElementById('phone').value;
            const useAutoProxy = document.getElementById('useAutoProxy').checked;

            const formData = new FormData();
            formData.append('phone', phone);
            formData.append('use_auto_proxy', useAutoProxy);

            try {
                const response = await fetch('/accounts/add', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert('Аккаунт успешно добавлен!');
                    location.reload();
                } else if (result.status === 'code_required') {
                    showCodeModal(phone, result.phone_code_hash, result.session_name, useAutoProxy ? 'auto' : '');
                } else {
                    alert('Ошибка: ' + result.message);
                }
            } catch (error) {
                alert('Ошибка при добавлении аккаунта: ' + error.message);
            }
        });

        // Обработчик формы импорта TDATA
        document.getElementById('addTdataForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const tdataFiles = document.getElementById('tdataFiles').files;
            const useAutoProxy = document.getElementById('useAutoProxyTdata').checked;

            if (tdataFiles.length === 0) {
                alert('Выберите файлы TDATA');
                return;
            }

            const formData = new FormData();
            for (let file of tdataFiles) {
                formData.append('tdata_files', file);
            }
            formData.append('use_auto_proxy', useAutoProxy);

            // Показываем прогресс
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Импорт...';

            try {
                const response = await fetch('/accounts/add_tdata', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert(`Аккаунт успешно импортирован!\nИмя: ${result.name}\nТелефон: ${result.phone}`);
                    location.reload();
                } else {
                    alert('Ошибка импорта: ' + result.message);
                }
            } catch (error) {
                alert('Ошибка при импорте TDATA: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

// Вспомогательная функция для показа модального окна ввода кода
function showCodeModal(phone, phoneCodeHash, sessionName, proxy) {
    const codeForm = document.getElementById('codeForm');
    codeForm.querySelector('input[name="phone"]').value = phone;
    codeForm.querySelector('input[name="phone_code_hash"]').value = phoneCodeHash;
    codeForm.querySelector('input[name="session_name"]').value = sessionName;
    codeForm.querySelector('input[name="proxy"]').value = proxy;

    new bootstrap.Modal(document.getElementById('codeModal')).show();
    bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
}
</script>
{% endblock %}