{% extends "base.html" %}

{% block title %}–ê–∫–∫–∞—É–Ω—Ç—ã - Telegram Mass Sender{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
        <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
    </button>
</div>

<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                <th>–ò–º—è</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–ü—Ä–æ–∫—Å–∏</th>
                <th>–°–æ–æ–±—â–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for account in accounts %}
            <tr>
                <td>{{ account.id }}</td>
                <td>{{ account.phone }}</td>
                <td>{{ account.name or '-' }}</td>
                <td>
                    <span class="badge bg-{% if account.status == 'online' %}success{% elif account.status == 'offline' %}secondary{% elif account.status == 'error' %}danger{% else %}warning{% endif %}">
                        {{ account.status }}
                    </span>
                </td>
                <td>{{ account.proxy or '-' }}</td>
                <td>{{ account.messages_sent_today }}</td>
                <td>{{ account.last_activity.strftime('%d.%m.%Y %H:%M') if account.last_activity else '-' }}</td>
                <td>
                    <button class="btn btn-sm btn-{% if account.is_active %}warning{% else %}success{% endif %}"
                            onclick="toggleAccount({{ account.id }})">
                        {% if account.is_active %}–û—Ç–∫–ª—é—á–∏—Ç—å{% else %}–í–∫–ª—é—á–∏—Ç—å{% endif %}
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="deleteTelegramAccount({{ account.id }})" title="–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –∏–∑ Telegram –Ω–∞–≤—Å–µ–≥–¥–∞">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–∑ TG
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteAccount({{ account.id }})">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>
                    –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç Telegram
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º -->
                <ul class="nav nav-tabs mb-4" id="addAccountTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="phone-tab" data-bs-toggle="tab" data-bs-target="#phone-pane" type="button" role="tab">
                            <i class="fas fa-phone me-2"></i>
                            –ü–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tdata-tab" data-bs-toggle="tab" data-bs-target="#tdata-pane" type="button" role="tab">
                            <i class="fas fa-folder-open me-2"></i>
                            –ò–º–ø–æ—Ä—Ç TDATA
                        </button>
                    </li>
                </ul>

                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
                <div class="tab-content" id="addAccountTabContent">
                    <!-- –í–∫–ª–∞–¥–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ –Ω–æ–º–µ—Ä—É -->
                    <div class="tab-pane fade show active" id="phone-pane" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8 mx-auto">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="text-center mb-4">
                                            <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                                <i class="fas fa-mobile-alt text-primary" style="font-size: 24px;"></i>
                                            </div>
                                            <h6 class="mt-3 mb-2">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h6>
                                            <p class="text-muted small">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏</p>
                                        </div>

                                        <form id="addAccountForm">
                                            <div class="mb-4">
                                                <label for="phone" class="form-label fw-bold">
                                                    <i class="fas fa-phone me-2 text-primary"></i>
                                                    –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                                                </label>
                                                <input type="text" class="form-control form-control-lg" id="phone"
                                                       placeholder="+1234567890" required>
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                                                </div>
                                            </div>

                                            <div class="mb-4">
                                                <div class="card bg-light border-0">
                                                    <div class="card-body p-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="useAutoProxy">
                                                            <label class="form-check-label fw-bold" for="useAutoProxy">
                                                                <i class="fas fa-shield-alt me-2 text-success"></i>
                                                                –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–∫—Å–∏
                                                            </label>
                                                            <div class="form-text small mt-1">
                                                                –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-primary btn-lg">
                                                    <i class="fas fa-paper-plane me-2"></i>
                                                    –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –í–∫–ª–∞–¥–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ TDATA -->
                    <div class="tab-pane fade" id="tdata-pane" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8 mx-auto">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="text-center mb-4">
                                            <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                                <i class="fas fa-upload text-success" style="font-size: 24px;"></i>
                                            </div>
                                            <h6 class="mt-3 mb-2">–ò–º–ø–æ—Ä—Ç TDATA —Ñ–∞–π–ª–æ–≤</h6>
                                            <p class="text-muted small">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –∏–∑ –ø–∞–ø–∫–∏ TDATA Telegram Desktop</p>
                                        </div>

                                        <form id="addTdataForm" enctype="multipart/form-data">
                                            <div class="mb-4">
                                                <label for="tdataFiles" class="form-label fw-bold">
                                                    <i class="fas fa-folder-open me-2 text-success"></i>
                                                    –§–∞–π–ª—ã TDATA
                                                </label>
                                                <div class="file-upload-area">
                                                    <input type="file" class="form-control" id="tdataFiles" multiple accept="*" required>
                                                </div>
                                                <div class="alert alert-info mt-3 py-2">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    <strong>–ü—É—Ç—å –∫ –ø–∞–ø–∫–µ TDATA:</strong><br>
                                                    <small class="d-block mt-1">
                                                        <i class="fab fa-windows me-1"></i> Windows: <code>%APPDATA%\Telegram Desktop\tdata</code><br>
                                                        <i class="fab fa-apple me-1"></i> macOS: <code>~/Library/Application Support/Telegram Desktop/tdata</code><br>
                                                        <i class="fab fa-linux me-1"></i> Linux: <code>~/.local/share/TelegramDesktop/tdata</code>
                                                    </small>
                                                </div>
                                            </div>

                                            <div class="mb-4">
                                                <div class="card bg-light border-0">
                                                    <div class="card-body p-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="useAutoProxyTdata">
                                                            <label class="form-check-label fw-bold" for="useAutoProxyTdata">
                                                                <i class="fas fa-shield-alt me-2 text-success"></i>
                                                                –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–∫—Å–∏
                                                            </label>
                                                            <div class="form-text small mt-1">
                                                                –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-success btn-lg">
                                                    <i class="fas fa-download me-2"></i>
                                                    –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å TDATA
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫–æ–¥–∞ -->
<div class="modal fade" id="codeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</h5>
            </div>
            <div class="modal-body">
                <form id="codeForm">
                    <input type="hidden" name="phone">
                    <input type="hidden" name="phone_code_hash">
                    <input type="hidden" name="session_name">
                    <input type="hidden" name="proxy">
                    <div class="mb-3">
                        <label class="form-label">–ö–æ–¥ –∏–∑ Telegram</label>
                        <input type="text" class="form-control" name="code" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="verifyCode()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è 2FA -->
<div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h5>
            </div>
            <div class="modal-body">
                <form id="passwordForm">
                    <input type="hidden" name="phone">
                    <input type="hidden" name="session_name">
                    <input type="hidden" name="proxy">
                    <div class="mb-3">
                        <label class="form-label">–ü–∞—Ä–æ–ª—å 2FA</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="verifyPassword()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function addAccount() {
    const form = document.getElementById('addAccountForm');
    const formData = new FormData(form);

    // –ï—Å–ª–∏ —á–µ–∫–±–æ–∫—Å "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–∫—Å–∏" –Ω–µ –æ—Ç–º–µ—á–µ–Ω, —É–¥–∞–ª—è–µ–º –µ–≥–æ –∏–∑ formData
    if (!formData.get('use_auto_proxy')) {
        formData.delete('use_auto_proxy');
    }


    fetch('/accounts/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'code_required') {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫–æ–¥–∞
            const codeForm = document.getElementById('codeForm');
            codeForm.phone.value = formData.get('phone');
            codeForm.phone_code_hash.value = data.phone_code_hash;
            codeForm.session_name.value = data.session_name;
            // –ü–µ—Ä–µ–¥–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ use_auto_proxy, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
            codeForm.proxy.value = formData.get('use_auto_proxy') ? 'auto' : formData.get('proxy') || '';


            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–≤–æ–¥–∞ –∫–æ–¥–∞
            new bootstrap.Modal(document.getElementById('codeModal')).show();
            bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
        } else if (data.status === 'success') {
            alert('–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞: ' + error);
    });
}

function verifyCode() {
    const form = document.getElementById('codeForm');
    const formData = new FormData(form);

    fetch('/accounts/verify_code', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'password_required') {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è
            const passwordForm = document.getElementById('passwordForm');
            passwordForm.phone.value = formData.get('phone');
            passwordForm.session_name.value = data.session_name;
            passwordForm.proxy.value = formData.get('proxy') || ''; // –°–æ—Ö—Ä–∞–Ω—è–µ–º proxy, –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ —É–∫–∞–∑–∞–Ω–æ –≤—Ä—É—á–Ω—É—é

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è
            new bootstrap.Modal(document.getElementById('passwordModal')).show();
            bootstrap.Modal.getInstance(document.getElementById('codeModal')).hide();
        } else if (data.status === 'success') {
            alert('–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞: ' + error);
    });
}

function verifyPassword() {
    const form = document.getElementById('passwordForm');
    const formData = new FormData(form);

    fetch('/accounts/verify_password', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞: ' + error);
    });
}

function toggleAccount(accountId) {
    fetch(`/accounts/${accountId}/toggle`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    });
}

function deleteAccount(accountId) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç?')) {
        fetch(`/accounts/${accountId}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.message);
            }
        });
    }
}

function deleteTelegramAccount(accountId) {
            const reason = prompt('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ –∏–∑ Telegram:', '–ë–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω');
            if (reason !== null && confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ –ü–û–õ–ù–û–°–¢–¨–Æ —É–¥–∞–ª–∏—Ç –∞–∫–∫–∞—É–Ω—Ç –∏–∑ Telegram –Ω–∞–≤—Å–µ–≥–¥–∞!\n\n–ê–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ –ø–æ—Ç–µ—Ä—è–Ω. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                const formData = new FormData();
                formData.append('reason', reason);

                fetch(`/accounts/${accountId}/delete_telegram`, { 
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('‚úÖ ' + data.message);
                        location.reload();
                    } else {
                        alert('‚ùå –û—à–∏–±–∫–∞: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + error);
                });
            }
        }

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ –Ω–æ–º–µ—Ä—É
document.getElementById('addAccountForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const phone = document.getElementById('phone').value;
    const useAutoProxy = document.getElementById('useAutoProxy').checked;

    const formData = new FormData();
    formData.append('phone', phone);
    formData.append('use_auto_proxy', useAutoProxy);

    try {
        const response = await fetch('/accounts/add', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.status === 'success') {
            alert('–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
            location.reload();
        } else if (result.status === 'code_required') {
            showCodeModal(phone, result.phone_code_hash, result.session_name, useAutoProxy ? 'auto' : '');
        } else {
            alert('–û—à–∏–±–∫–∞: ' + result.message);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞: ' + error.message);
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –∏–º–ø–æ—Ä—Ç–∞ TDATA
document.getElementById('addTdataForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const tdataFiles = document.getElementById('tdataFiles').files;
    const useAutoProxy = document.getElementById('useAutoProxyTdata').checked;

    if (tdataFiles.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã TDATA');
        return;
    }

    const formData = new FormData();
    for (let file of tdataFiles) {
        formData.append('tdata_files', file);
    }
    formData.append('use_auto_proxy', useAutoProxy);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = '–ò–º–ø–æ—Ä—Ç...';

    try {
        const response = await fetch('/accounts/add_tdata', {
            method: 'POST',
            body: formData
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç: ' + text.substring(0, 100));
        }

        const result = await response.json();

        if (result.status === 'success') {
            alert(`TDATA –∞–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!\n–ò–º—è: ${result.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${result.phone || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
            location.reload();
        } else {
            const errorMsg = result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞';
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ TDATA: ' + errorMsg);
        }
    } catch (error) {
        console.error('TDATA import error:', error);
        let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ TDATA';

        if (error.message.includes('Failed to fetch')) {
            errorMessage = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.';
        } else if (error.message.includes('HTTP')) {
            errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + error.message;
        } else {
            errorMessage += ': ' + error.message;
        }

        alert(errorMessage);
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ —É–¥–∞–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;

        const progressDiv = this.querySelector('.alert-info');
        if (progressDiv) {
            progressDiv.remove();
        }
    }
});

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤–≤–æ–¥–∞ –∫–æ–¥–∞
function showCodeModal(phone, phoneCodeHash, sessionName, proxy) {
    const codeForm = document.getElementById('codeForm');
    codeForm.querySelector('input[name="phone"]').value = phone;
    codeForm.querySelector('input[name="phone_code_hash"]').value = phoneCodeHash;
    codeForm.querySelector('input[name="session_name"]').value = sessionName;
    codeForm.querySelector('input[name="proxy"]').value = proxy;

    new bootstrap.Modal(document.getElementById('codeModal')).show();
    bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
}
</script>
{% endblock %}