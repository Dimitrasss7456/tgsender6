{% extends "base.html" %}

{% block title %}Аккаунты - Telegram Mass Sender{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Управление аккаунтами</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
        <i class="fas fa-plus"></i> Добавить аккаунт
    </button>
</div>

<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Телефон</th>
                <th>Имя</th>
                <th>Статус</th>
                <th>Прокси</th>
                <th>Сообщений сегодня</th>
                <th>Последняя активность</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for account in accounts %}
            <tr>
                <td>{{ account.id }}</td>
                <td>{{ account.phone }}</td>
                <td>{{ account.name or '-' }}</td>
                <td>
                    <span class="badge bg-{% if account.status == 'online' %}success{% elif account.status == 'offline' %}secondary{% elif account.status == 'error' %}danger{% else %}warning{% endif %}">
                        {{ account.status }}
                    </span>
                </td>
                <td>{{ account.proxy or '-' }}</td>
                <td>{{ account.messages_sent_today }}</td>
                <td>{{ account.last_activity.strftime('%d.%m.%Y %H:%M') if account.last_activity else '-' }}</td>
                <td>
                    <button class="btn btn-sm btn-{% if account.is_active %}warning{% else %}success{% endif %}"
                            onclick="toggleAccount({{ account.id }})">
                        {% if account.is_active %}Отключить{% else %}Включить{% endif %}
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteAccount({{ account.id }})">
                        Удалить
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Модальное окно добавления аккаунта -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>
                    Добавить аккаунт Telegram
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Навигация по вкладкам -->
                <ul class="nav nav-tabs mb-4" id="addAccountTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="phone-tab" data-bs-toggle="tab" data-bs-target="#phone-pane" type="button" role="tab">
                            <i class="fas fa-phone me-2"></i>
                            По номеру телефона
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tdata-tab" data-bs-toggle="tab" data-bs-target="#tdata-pane" type="button" role="tab">
                            <i class="fas fa-folder-open me-2"></i>
                            Импорт TDATA
                        </button>
                    </li>
                </ul>

                <!-- Содержимое вкладок -->
                <div class="tab-content" id="addAccountTabContent">
                    <!-- Вкладка добавления по номеру -->
                    <div class="tab-pane fade show active" id="phone-pane" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8 mx-auto">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="text-center mb-4">
                                            <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                                <i class="fas fa-mobile-alt text-primary" style="font-size: 24px;"></i>
                                            </div>
                                            <h6 class="mt-3 mb-2">Добавление по номеру телефона</h6>
                                            <p class="text-muted small">Введите номер телефона для создания новой сессии</p>
                                        </div>
                                        
                                        <form id="addAccountForm">
                                            <div class="mb-4">
                                                <label for="phone" class="form-label fw-bold">
                                                    <i class="fas fa-phone me-2 text-primary"></i>
                                                    Номер телефона
                                                </label>
                                                <input type="text" class="form-control form-control-lg" id="phone" 
                                                       placeholder="+1234567890" required>
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Укажите номер в международном формате
                                                </div>
                                            </div>
                                            
                                            <div class="mb-4">
                                                <div class="card bg-light border-0">
                                                    <div class="card-body p-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="useAutoProxy">
                                                            <label class="form-check-label fw-bold" for="useAutoProxy">
                                                                <i class="fas fa-shield-alt me-2 text-success"></i>
                                                                Использовать автоматический прокси
                                                            </label>
                                                            <div class="form-text small mt-1">
                                                                Рекомендуется для защиты от блокировок
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-primary btn-lg">
                                                    <i class="fas fa-paper-plane me-2"></i>
                                                    Добавить аккаунт
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка импорта TDATA -->
                    <div class="tab-pane fade" id="tdata-pane" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8 mx-auto">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="text-center mb-4">
                                            <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                                <i class="fas fa-upload text-success" style="font-size: 24px;"></i>
                                            </div>
                                            <h6 class="mt-3 mb-2">Импорт TDATA файлов</h6>
                                            <p class="text-muted small">Загрузите файлы из папки TDATA Telegram Desktop</p>
                                        </div>

                                        <form id="addTdataForm" enctype="multipart/form-data">
                                            <div class="mb-4">
                                                <label for="tdataFiles" class="form-label fw-bold">
                                                    <i class="fas fa-folder-open me-2 text-success"></i>
                                                    Файлы TDATA
                                                </label>
                                                <div class="file-upload-area">
                                                    <input type="file" class="form-control" id="tdataFiles" multiple accept="*" required>
                                                </div>
                                                <div class="alert alert-info mt-3 py-2">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    <strong>Путь к папке TDATA:</strong><br>
                                                    <small class="d-block mt-1">
                                                        <i class="fab fa-windows me-1"></i> Windows: <code>%APPDATA%\Telegram Desktop\tdata</code><br>
                                                        <i class="fab fa-apple me-1"></i> macOS: <code>~/Library/Application Support/Telegram Desktop/tdata</code><br>
                                                        <i class="fab fa-linux me-1"></i> Linux: <code>~/.local/share/TelegramDesktop/tdata</code>
                                                    </small>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-4">
                                                <div class="card bg-light border-0">
                                                    <div class="card-body p-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="useAutoProxyTdata">
                                                            <label class="form-check-label fw-bold" for="useAutoProxyTdata">
                                                                <i class="fas fa-shield-alt me-2 text-success"></i>
                                                                Использовать автоматический прокси
                                                            </label>
                                                            <div class="form-text small mt-1">
                                                                Рекомендуется для защиты от блокировок
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-success btn-lg">
                                                    <i class="fas fa-download me-2"></i>
                                                    Импортировать TDATA
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения кода -->
<div class="modal fade" id="codeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Введите код подтверждения</h5>
            </div>
            <div class="modal-body">
                <form id="codeForm">
                    <input type="hidden" name="phone">
                    <input type="hidden" name="phone_code_hash">
                    <input type="hidden" name="session_name">
                    <input type="hidden" name="proxy">
                    <div class="mb-3">
                        <label class="form-label">Код из Telegram</label>
                        <input type="text" class="form-control" name="code" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="verifyCode()">Подтвердить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно ввода пароля 2FA -->
<div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Двухфакторная аутентификация</h5>
            </div>
            <div class="modal-body">
                <form id="passwordForm">
                    <input type="hidden" name="phone">
                    <input type="hidden" name="session_name">
                    <input type="hidden" name="proxy">
                    <div class="mb-3">
                        <label class="form-label">Пароль 2FA</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="verifyPassword()">Подтвердить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function addAccount() {
    const form = document.getElementById('addAccountForm');
    const formData = new FormData(form);

    // Если чекбокс "Использовать автоматический прокси" не отмечен, удаляем его из formData
    if (!formData.get('use_auto_proxy')) {
        formData.delete('use_auto_proxy');
    }


    fetch('/accounts/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'code_required') {
            // Заполняем скрытые поля для подтверждения кода
            const codeForm = document.getElementById('codeForm');
            codeForm.phone.value = formData.get('phone');
            codeForm.phone_code_hash.value = data.phone_code_hash;
            codeForm.session_name.value = data.session_name;
            // Передаем значение use_auto_proxy, если оно есть
            codeForm.proxy.value = formData.get('use_auto_proxy') ? 'auto' : formData.get('proxy') || '';


            // Показываем модальное окно ввода кода
            new bootstrap.Modal(document.getElementById('codeModal')).show();
            bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
        } else if (data.status === 'success') {
            alert('Аккаунт успешно добавлен!');
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        alert('Ошибка: ' + error);
    });
}

function verifyCode() {
    const form = document.getElementById('codeForm');
    const formData = new FormData(form);

    fetch('/accounts/verify_code', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'password_required') {
            // Заполняем скрытые поля для ввода пароля
            const passwordForm = document.getElementById('passwordForm');
            passwordForm.phone.value = formData.get('phone');
            passwordForm.session_name.value = data.session_name;
            passwordForm.proxy.value = formData.get('proxy') || ''; // Сохраняем proxy, если оно было указано вручную

            // Показываем модальное окно ввода пароля
            new bootstrap.Modal(document.getElementById('passwordModal')).show();
            bootstrap.Modal.getInstance(document.getElementById('codeModal')).hide();
        } else if (data.status === 'success') {
            alert('Аккаунт успешно добавлен!');
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        alert('Ошибка: ' + error);
    });
}

function verifyPassword() {
    const form = document.getElementById('passwordForm');
    const formData = new FormData(form);

    fetch('/accounts/verify_password', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Аккаунт успешно добавлен!');
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        alert('Ошибка: ' + error);
    });
}

function toggleAccount(accountId) {
    fetch(`/accounts/${accountId}/toggle`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    });
}

function deleteAccount(accountId) {
    if (confirm('Вы уверены, что хотите удалить этот аккаунт?')) {
        fetch(`/accounts/${accountId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Ошибка: ' + data.message);
            }
        });
    }
}

// Вкладки уже обрабатываются Bootstrap, удаляем старый код переключения

        // Обработчик формы добавления аккаунта по номеру
        document.getElementById('addAccountForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const phone = document.getElementById('phone').value;
            const useAutoProxy = document.getElementById('useAutoProxy').checked;

            const formData = new FormData();
            formData.append('phone', phone);
            formData.append('use_auto_proxy', useAutoProxy);

            try {
                const response = await fetch('/accounts/add', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert('Аккаунт успешно добавлен!');
                    location.reload();
                } else if (result.status === 'code_required') {
                    showCodeModal(phone, result.phone_code_hash, result.session_name, useAutoProxy ? 'auto' : '');
                } else {
                    alert('Ошибка: ' + result.message);
                }
            } catch (error) {
                alert('Ошибка при добавлении аккаунта: ' + error.message);
            }
        });

        // Обработчик формы импорта TDATA
        document.getElementById('addTdataForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const tdataFiles = document.getElementById('tdataFiles').files;
            const useAutoProxy = document.getElementById('useAutoProxyTdata').checked;

            if (tdataFiles.length === 0) {
                alert('Выберите файлы TDATA');
                return;
            }

            const formData = new FormData();
            for (let file of tdataFiles) {
                formData.append('tdata_files', file);
            }
            formData.append('use_auto_proxy', useAutoProxy);

            // Показываем прогресс
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Импорт...';

            try {
                const response = await fetch('/accounts/add_tdata', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert(`Аккаунт успешно импортирован!\nИмя: ${result.name}\nТелефон: ${result.phone}`);
                    location.reload();
                } else {
                    alert('Ошибка импорта: ' + result.message);
                }
            } catch (error) {
                alert('Ошибка при импорте TDATA: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

// Вспомогательная функция для показа модального окна ввода кода
function showCodeModal(phone, phoneCodeHash, sessionName, proxy) {
    const codeForm = document.getElementById('codeForm');
    codeForm.querySelector('input[name="phone"]').value = phone;
    codeForm.querySelector('input[name="phone_code_hash"]').value = phoneCodeHash;
    codeForm.querySelector('input[name="session_name"]').value = sessionName;
    codeForm.querySelector('input[name="proxy"]').value = proxy;

    new bootstrap.Modal(document.getElementById('codeModal')).show();
    bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
}
</script>
{% endblock %}